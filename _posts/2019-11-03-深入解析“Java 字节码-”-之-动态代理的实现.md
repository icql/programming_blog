---
layout:     post
title:      æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€ŒåŠ¨æ€ä»£ç†çš„å®ç°ã€
subtitle:   
date:       2019-11-3
author:     tomaså®¶çš„å°æ‹¨æµªé¼“
header-img: img/post-bg-20191014-article1.jpg
catalog: true
tags:
    - Java
    - JVM
---
# æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€ŒåŠ¨æ€ä»£ç†çš„å®ç°ã€


> æœ¬æ–‡ä¸»è¦æ˜¯ã€Šæ·±å…¥æ¢ç´¢ JVMã€‹ç³»åˆ—ä¸­ã€å­—èŠ‚ç ç¯‡ã€æ–‡ç« ï¼Œä¸»è¦é€šè¿‡æ¡ˆä¾‹æ¥æ›´åŠ å½¢è±¡çš„äº†è§£ã€Œè™šæ‹Ÿæœºå­—èŠ‚ç ã€çš„å®ç°ã€‚ç³»åˆ—æ–‡ç« ç›®å½•è§ï¼š[ã€Š æ·±å…¥æ¢ç´¢ JVM ã€‹æ–‡é›†](/programming_blog/2019/11/04/æ·±å…¥æ¢ç´¢-JVM-æ–‡é›†/)

<br>

**ã€å­—èŠ‚ç ã€ç¯‡æ–‡ç« æ¨èï¼š**   
[æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€Œç±»æ–‡ä»¶ç»“æ„ã€](/programming_blog/2019/11/01/æ·±å…¥è§£æ-Java-å­—èŠ‚ç -ä¹‹-ç±»æ–‡ä»¶ç»“æ„/)  
[æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€Œä»æ¡ˆä¾‹æ·±åº¦è§£è¯» Java å­—èŠ‚ç ã€](/programming_blog/2019/11/02/æ·±å…¥è§£æ-Java-å­—èŠ‚ç -ä¹‹-ä»æ¡ˆä¾‹æ·±åº¦è§£è¯»-Java-å­—èŠ‚ç /)  
[æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€Œè¿›ä¸€æ­¥æ¢ç©¶ Java æ–¹æ³•çš„å­—èŠ‚ç å®ç°ã€](/programming_blog/2019/11/03/æ·±å…¥è§£æ-Java-å­—èŠ‚ç -ä¹‹-è¿›ä¸€æ­¥æ¢ç©¶-Java-æ–¹æ³•çš„å­—èŠ‚ç å®ç°/)  
[æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€Œä»æ¡ˆä¾‹è§£è¯»è™šæ‹Ÿæœºå±æ€§è¡¨ã€](/programming_blog/2019/11/03/æ·±å…¥è§£æ-Java-å­—èŠ‚ç -ä¹‹-ä»æ¡ˆä¾‹è§£è¯»è™šæ‹Ÿæœºå±æ€§è¡¨/)  
[æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€Œè™šæ‹Ÿæœºæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“ã€](/programming_blog/2019/11/03/æ·±å…¥è§£æ-Java-å­—èŠ‚ç -ä¹‹-è™šæ‹Ÿæœºæœºå­—èŠ‚ç æ‰§è¡Œå¼•æ“/)  
[æ·±å…¥è§£æâ€œJava å­—èŠ‚ç  â€ ä¹‹ ã€ŒåŠ¨æ€ä»£ç†çš„å®ç°ã€](/programming_blog/2019/11/03/æ·±å…¥è§£æ-Java-å­—èŠ‚ç -ä¹‹-åŠ¨æ€ä»£ç†çš„å®ç°/)  

<br>

## ä¸€ï¼Œå‰è¨€

åœ¨Javaé‡Œé¢é™¤äº†javacå’Œå­—èŠ‚ç ç±»åº“å¤–ï¼Œä½¿ç”¨å­—èŠ‚ç ç”Ÿæˆçš„ä¾‹å­è¿˜æœ‰å¾ˆå¤šï¼Œå¦‚WebæœåŠ¡å™¨ä¸­çš„JSPç¼–è¯‘å™¨ï¼Œç¼–è¯‘æ—¶æ¤å…¥çš„AOPæ¡†æ¶ï¼Œè¿˜æœ‰å¾ˆå¸¸ç”¨çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œç”šè‡³åœ¨ä½¿ç”¨åå°„çš„æ—¶å€™è™šæ‹Ÿæœºéƒ½æœ‰å¯èƒ½ä¼šåœ¨è¿è¡Œæ—¶ç”Ÿæˆå­—èŠ‚ç æ¥æé«˜æ‰§è¡Œé€Ÿåº¦ã€‚

<br>

## äºŒï¼ŒåŠ¨æ€ä»£ç†

å¯¹äº Spring çš„ AOPï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªç›¸åº”çš„ä»£ç†ç±»ï¼Œä»£ç†æˆ‘ä»¬çœŸå®ç›®æ ‡çš„ beenã€‚  
å¯¹äº Spring æ¥è¯´ï¼Œå®ƒä¸»è¦åŸºäºä¸¤ç§æ‰‹æ®µæ¥å»å®ç° AOP åŠŸèƒ½ï¼š  
â‘  é‡‡ç”¨åƒ CGLIB è¿™æ ·å­—èŠ‚ç çš„åº“ï¼Œå®ƒå¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€çš„æ ¹æ®æˆ‘ä»¬çš„æŒ‡å®šçš„ç±»å‹æ¥å»ç”Ÿæˆç›¸åº”çš„ Classã€‚  
â‘¡ åŸºäº Java çš„åŠ¨æ€ä»£ç†ã€‚åŠ¨æ€ä»£ç†çš„é™åˆ¶ï¼šåªèƒ½å¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œä¸èƒ½å¯¹å…·ä½“çš„ç±»è¿›è¡Œä»£ç†ã€‚
å› ä¸ºæˆ‘ä»¬ä½¿ç”¨ Spring ä¸€èˆ¬éƒ½æ˜¯é¢å‘æ¥å£ç¼–ç¨‹ï¼Œå› æ­¤ Spring çš„å¯¹äºæ¥å£çš„ä»£ç†éƒ½ä¼šä½¿ç”¨ Java çš„åŠ¨æ€ä»£ç†æ¥å»å®ç°ã€‚  

* ä¾‹å­

~~~java
# Subject
public interface Subject {
    void request();
}

# RealSubject
public class RealSubject implements Subject {
    @Override
    public void request() {
        System.out.println("From real subject");
    }
}
# DynamicSubject
public class DynamicSubject implements InvocationHandler{
    private Object sub;
    public DynamicSubject(Object obj) {
        this.sub = obj;
    }
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("before calling : "+ method);
        method.invoke(sub, args);
        System.out.println("after calling : " + method);
        return null;
    }
}

# Client
public class Client {
    public static void main(String[] args) {
        RealSubject rs = new RealSubject();
        InvocationHandler ds = new DynamicSubject(rs);
        Class<?> cls = rs.getClass();
        Subject subject = (Subject) Proxy.newProxyInstance(cls.getClassLoader(), cls.getInterfaces(), ds);
        subject.request();
        /*
            è¾“å‡ºï¼šclass com.sun.proxy.$Proxy0
            è¿™ä¸ªç±»å®é™…ä¸Šæ˜¯åœ¨ç¨‹åºè¿è¡ŒæœŸåŠ¨æ€çš„åˆ›å»ºå‡ºæ¥çš„ï¼
         */
        System.out.println(subject.getClass());
        // class java.lang.reflect.Proxy
        System.out.println(subject.getClass().getSuperclass());
    }
}
~~~

* ä»æºç åˆ†æâ€œåŠ¨æ€ä»£ç†â€çš„å­—èŠ‚ç ç”Ÿæˆè¿‡ç¨‹

![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8nk50tdxej30fq0gcacm.jpg)  
â‘  æŸ¥æ‰¾æˆ–æ„å»ºæŒ‡å®šçš„ä»£ç†ç±»çš„Classï¼ˆè¯¥è¿‡ç¨‹å°±ä¼šåŠ¨æ€ç”ŸæˆæŒ‡å®šä»£ç†ç±»çš„å­—èŠ‚ç ï¼Œç„¶åé€šè¿‡åŠ è½½åŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç å®ç°è¿™ä¸ªåŠ¨æ€ä»£ç†ç±»çš„åŠ è½½ï¼‰ã€‚  
â‘¡ è·å–æŒ‡å®šçš„ä»£ç†ç±»Classçš„ç‰¹å®šConstructorï¼Œè¯¥æ„é€ æ–¹æ³•è¦æ±‚å…·æœ‰å”¯ä¸€ä¸€ä¸ªç±»å‹ä¸ºInvocationHandlerçš„å‚æ•°ã€‚  
â‘¢ é€šè¿‡åå°„åˆ›å»ºæŒ‡å®šçš„ä»£ç†ç±»ï¼Œè¿™é‡Œä¼šä¼ å…¥æˆ‘ä»¬è‡ªå·±å®ç°çš„ DynamicSubject ç±»ï¼ˆInvocationHandler æ¥å£çš„å®ç°ç±»ï¼‰ä½œä¸ºæ„é€ æ–¹æ³•çš„å‚æ•°ã€‚  

<br>

ã€ŒgetProxyClass0(loader, intfs);ã€  
![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8nk5t35i7j30g706q3zp.jpg)  

è¿›å…¥ ã€Œprivate static final class ProxyClassFactory    implements BiFunction<ClassLoader, Class<?>[], Class<?>>ã€ç±»çš„ã€Œpublic Class<?> apply(ClassLoader loader, Class<?>[] interfaces)ã€æ–¹æ³•ï¼š  
![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8nk6w4ynij30ez08mta4.jpg)  
![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8nk7c1gf7j30qi0cdtb7.jpg)

> æ³¨æ„ï¼šä¸Šé¢æœ‰ä¸ªã€ŒsaveGeneratedFilesã€å­—æ®µå¯ä»¥æ§åˆ¶æ˜¯å¦å°†åŠ¨æ€ç”Ÿæˆçš„å¯¹è±¡çš„å­—èŠ‚ç æ–‡ä»¶ä¿å­˜åˆ°ç£ç›˜ä¸­ã€‚

~~~java
private static final boolean saveGeneratedFiles = ((Boolean)AccessController.doPrivileged(new GetBooleanAction("sun.misc.ProxyGenerator.saveGeneratedFiles"))).booleanValue();
~~~

ä¿®æ”¹ï¼š

~~~java
# Client
public class Client {
    public static void main(String[] args) {
        System.getProperties().put("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");
        RealSubject rs = new RealSubject();
        InvocationHandler ds = new DynamicSubject(rs);
        Class<?> cls = rs.getClass();
        Subject subject = (Subject) Proxy.newProxyInstance(cls.getClassLoader(), cls.getInterfaces(), ds);
        subject.request();
        /*
            è¾“å‡ºï¼šclass com.sun.proxy.$Proxy0
            è¿™ä¸ªç±»å®é™…ä¸Šæ˜¯åœ¨ç¨‹åºè¿è¡ŒæœŸåŠ¨æ€çš„åˆ›å»ºå‡ºæ¥çš„ï¼
         */
        System.out.println(subject.getClass());
        // class java.lang.reflect.Proxy
        System.out.println(subject.getClass().getSuperclass());
        // interface com.bayern.shengsiyuan.jvm_lecture.bytecode.Subject
        Arrays.stream(subject.getClass().getInterfaces()).forEach(System.out::println);
    }
}
~~~

è¿è¡Œåå¾—åˆ°ï¼š  
![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8nk8uc2bpj305f078dg3.jpg)  
è¿™å°±æ˜¯è¿è¡ŒæœŸæ‰€ç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼

ã€Œ$Proxy0.classã€ï¼š  
![](https://tva1.sinaimg.cn/large/006y8mN6ly1g8nk9vx7sdj30k015rn3a.jpg)  
ğŸ‘†çš„ã€Œsuper.h.invoke(...)ã€æœ¬è´¨ä¸Šéƒ½ä¼šè°ƒç”¨åˆ°æˆ‘ä»¬è‡ªå·±å®ç°çš„InvocationHandlerçš„å®ç°ç±» â€”â€” ã€ŒDynamicSubject#invokeã€æ–¹æ³•ï¼Œã€ŒDynamicSubject#invokeã€ä¸­ä¼šå»è°ƒç”¨çœŸå®å¯¹è±¡çš„ç›¸åº”çš„æ–¹æ³•ã€‚  
ä¹Ÿå°±æ˜¯è¯´ï¼Œæœ¬ä¾‹å­ä¸­ã€Œequalsã€ã€ã€ŒtoStringã€ã€ã€ŒhashCodeã€ã€ã€Œrequestã€æ–¹æ³•æœ€ç»ˆéƒ½ä¼šé€šè¿‡åŠ¨æ€ä»£ç†è°ƒç”¨åˆ°çœŸå®çš„ RealSubject çš„å¯¹åº”çš„æ–¹æ³•ã€‚

> `å¯è§ï¼ŒJava çš„ Proxy å®ç°çš„åŠ¨æ€ä»£ç†ï¼Œæ˜¯ä¼šå¯¹ä»£ç†ç±»çš„æ‰€æœ‰æ–¹æ³•ç”Ÿæ•ˆçš„ï¼ï¼ï¼è€Œæ— æ³•å¯¹ä¸åŒçš„æ–¹æ³•è¿›è¡Œä¸åŒçš„ä»£ç†å®ç°ï¼ï¼ï¼`

åŒæ—¶æ³¨æ„ï¼Œã€Œequalsã€ã€ã€ŒtoStringã€ã€ã€ŒhashCodeã€æ˜¯ä» Object ç»§æ‰¿æ¥çš„æ–¹æ³•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒObject çš„è¿™ä¸‰ä¸ªæ–¹æ³•æ˜¯ä¼šé€šè¿‡åŠ¨æ€ä»£ç†æ¥è°ƒç”¨çœŸå®å¯¹è±¡çš„å¯¹åº”çš„æ–¹æ³•çš„ï¼Œè€Œ Object ä¸­çš„å…¶ä»–æ–¹æ³•åˆ™ä¸ä¼šï¼

~~~
# Proxy doc æ–‡æ¡£
* <li>An invocation of the {@code hashCode},
* {@code equals}, or {@code toString} methods declared in
* {@code java.lang.Object} on a proxy instance will be encoded and
* dispatched to the invocation handler's {@code invoke} method in
* the same manner as interface method invocations are encoded and
* dispatched, as described above.  The declaring class of the
* {@code Method} object passed to {@code invoke} will be
* {@code java.lang.Object}.  Other public methods of a proxy
* instance inherited from {@code java.lang.Object} are not
* overridden by a proxy class, so invocations of those methods behave
* like they do for instances of {@code java.lang.Object}.
~~~








