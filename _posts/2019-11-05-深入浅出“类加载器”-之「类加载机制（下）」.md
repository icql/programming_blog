---
layout:     post
title:      æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸‹ï¼‰ã€
subtitle:   
date:       2019-11-5
author:     tomaså®¶çš„å°æ‹¨æµªé¼“
header-img: img/post-bg-20191014-article1.jpg
catalog: true
tags:
    - Java
    - JVM
---
# æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸‹ï¼‰ã€


> æœ¬æ–‡ä¸»è¦æ˜¯ã€Šæ·±å…¥æ¢ç´¢ JVMã€‹ç³»åˆ—ä¸­ã€ç±»åŠ è½½å™¨ã€ç³»åˆ—æ–‡ç« ï¼Œç»§ [æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸Šï¼‰ã€](/programming_blog/2019/11/04/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ç±»åŠ è½½æœºåˆ¶-ä¸Š/) ç»§ç»­å¯¹â€œç±»çš„åŠ è½½æœºåˆ¶â€å‰©ä½™çš„å†…å®¹åšè¯¦ç»†çš„ä»‹ç»ã€‚ç³»åˆ—æ–‡ç« ç›®å½•è§ï¼š[ã€Š æ·±å…¥æ¢ç´¢ JVM ã€‹æ–‡é›†](/programming_blog/2019/11/09/æ·±å…¥æ¢ç´¢-JVM-æ–‡é›†/)

<br>

**ã€ç±»åŠ è½½å™¨ã€ç¯‡æ–‡ç« æ¨èï¼š**   
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸Šï¼‰ã€](/programming_blog/2019/11/04/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ç±»åŠ è½½æœºåˆ¶-ä¸Š/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸‹ï¼‰ã€](/programming_blog/2019/11/05/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ç±»åŠ è½½æœºåˆ¶-ä¸‹/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€](/programming_blog/2019/11/06/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œä» sun.misc.Launcher ç±»æºç æ·±å…¥æ¢ç´¢ ClassLoaderã€](/programming_blog/2019/11/07/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ä»-sun.misc.Launcher-ç±»æºç æ·±å…¥æ¢ç´¢-ClassLoader/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œæ¡ˆä¾‹åˆ†æï¼šTomcat ç±»åŠ è½½å™¨æ¶æ„ã€](/programming_blog/2019/11/08/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-æ¡ˆä¾‹åˆ†æ-Tomcat-ç±»åŠ è½½å™¨æ¶æ„/)  



<br>

## ä¸€ï¼Œâ€œç±»åŠ è½½â€å›é¡¾

â€œåŠ è½½â€æ˜¯ç±»åŠ è½½æ—¶æœºçš„ç¬¬ä¸€é˜¶æ®µã€‚  
ç±»ä»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­å¼€å§‹ï¼Œåˆ°å¸è½½å‡ºå†…å­˜ä¸ºæ­¢ï¼Œå®ƒçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸåŒ…æ‹¬ï¼ˆ5ä¸ªé˜¶æ®µï¼‰ï¼š  
â‘  åŠ è½½ï¼ˆLoadingï¼‰  
â‘¡ è¿æ¥ï¼ˆLinkingï¼‰  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[1] éªŒè¯ï¼ˆVerificationï¼‰  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[2] å‡†å¤‡ï¼ˆPreparationï¼‰  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[3] è§£æï¼ˆResolutionï¼‰  
â‘¢ åˆå§‹åŒ–ï¼ˆInitializationï¼‰  
â‘£ ä½¿ç”¨ï¼ˆUsingï¼‰  
â‘¤ å¸è½½ï¼ˆUnloadingï¼‰  

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9okdmmn2wj30eq05pjru.jpg)

<br>

* ä»€ä¹ˆæ˜¯â€œåŠ è½½â€

åŠ è½½ï¼šå°±æ˜¯æŠŠäºŒè¿›åˆ¶å½¢å¼çš„ Java ç±»å‹è¯»å…¥ Java è™šæ‹Ÿæœºä¸­

ç±»çš„åŠ è½½çš„æœ€ç»ˆäº§å“æ˜¯ä½äºå†…å­˜ä¸­çš„ Class å¯¹è±¡ã€‚  
Class å¯¹è±¡å°è£…äº†ç±»åœ¨æ–¹æ³•åŒºå†…çš„æ•°æ®ç»“æ„ï¼Œå¹¶ä¸”å‘ Java ç¨‹åºå‘˜æä¾›äº†è®¿é—®æ–¹æ³•åŒºçš„æ•°æ®ç»“æ„çš„æ¥å£ã€‚

> æ³¨æ„ï¼š  
> ç±»çš„åŠ è½½å¹¶ä¸éœ€è¦ç­‰åˆ°æŸä¸ªç±»è¢«â€œé¦–æ¬¡ä¸»åŠ¨ä½¿ç”¨â€æ—¶å†åŠ è½½å®ƒã€‚JVM è§„èŒƒå…è®¸ç±»åŠ è½½å™¨åœ¨é¢„æ–™æŸä¸ªç±»å°†è¦è¢«ä½¿ç”¨æ—¶å°±é¢„å…ˆåŠ è½½å®ƒã€‚

<br>

## äºŒï¼Œâ€œç±»åŠ è½½å™¨â€ä»‹ç»

### 2.1 ä¸»è¦æœ‰2ç§ç±»å‹çš„ç±»åŠ è½½å™¨
1. Java è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨  
    â‘  æ ¹ç±»åŠ è½½å™¨ï¼ˆBootstrapï¼‰  
    â‘¡ æ‰©å±•ç±»åŠ è½½å™¨ï¼ˆExtensionï¼‰  
    â‘¢ ç³»ç»Ÿï¼ˆåº”ç”¨ï¼‰ç±»åŠ è½½å™¨ï¼ˆSystemï¼‰  
2. ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨  
    â‘  java.lang.ClassLoader çš„å­ç±»  
    â‘¡ ç”¨æˆ·å¯ä»¥å®šåˆ¶ç±»çš„åŠ è½½æ–¹å¼  
    
### 2.2 çˆ¶äº²(åŒäº²)å§”æ‰˜æœºåˆ¶
ä» JDK 1.2 ç‰ˆæœ¬å¼€å§‹ï¼Œç±»çš„åŠ è½½è¿‡ç¨‹é‡‡ç”¨çˆ¶äº²(åŒäº²)å§”æ‰˜æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶èƒ½æ›´å¥½åœ°ä¿è¯ Java å¹³å°çš„å®‰å…¨ã€‚åœ¨æ­¤å§”æ‰˜æœºåˆ¶ä¸­ï¼Œé™¤äº† Java è™šæ‹Ÿæœºè‡ªå¸¦çš„æ ¹ç±»åŠ è½½å™¨ä»¥å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½æœ‰ä¸”åªæœ‰ä¸€ä¸ªçˆ¶åŠ è½½å™¨ã€‚

<br>    

## ä¸‰ï¼Œæ·±å…¥â€œç±»åŠ è½½å™¨â€

å„ä¸ªåŠ è½½å™¨çš„åŠ è½½è·¯å¾„ï¼ˆIntelliJ IDEAç¯å¢ƒä¸‹ï¼‰ï¼š

~~~
public class MyTest18 {

    public static void main(String[] args) {

        System.out.println(System.getProperty("sun.boot.class.path"));
        System.out.println("=================");
        System.out.println(System.getProperty("java.ext.dirs"));
        System.out.println("=================");
        System.out.println(System.getProperty("java.class.path"));
    }
}

# æ§åˆ¶å°
/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/resources.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/rt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/sunrsasign.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jsse.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jce.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/charsets.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jfr.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/classes
=================
/Users/linling/Library/Java/Extensions:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext:/Library/Java/Extensions:/Network/Library/Java/Extensions:/System/Library/Java/Extensions:/usr/lib/java
=================
/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/charsets.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/deploy.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/cldrdata.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/dnsns.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/jaccess.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/jfxrt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/localedata.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/nashorn.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/sunec.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/sunjce_provider.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/sunpkcs11.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/ext/zipfs.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/javaws.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jce.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jfr.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jfxswt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/jsse.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/management-agent.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/plugin.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/resources.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/jre/lib/rt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/ant-javafx.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/dt.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/javafx-mx.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/jconsole.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/packager.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/sa-jdi.jar:/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home/lib/tools.jar:/Users/linling/Documents/code/IdeaWorkspace/shengsiyuan/jvm_lecture/out/production/classes:/Applications/IntelliJ IDEA.app/Contents/lib/idea_rt.jar
~~~

### 3.1 æ ¹ï¼ˆBootstrapï¼‰ç±»åŠ è½½å™¨
è¯¥åŠ è½½å™¨æ²¡æœ‰çˆ¶åŠ è½½å™¨ã€‚å®ƒè´Ÿè´£åŠ è½½è™šæ‹Ÿæœºçš„æ ¸å¿ƒç±»åº“ï¼Œå¦‚ java.lang.* ç­‰ã€‚æ ¹ç±»åŠ è½½å™¨ä»ç³»ç»Ÿå±æ€§ sun.boot.class.path æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ã€‚æ ¹ç±»åŠ è½½å™¨çš„å®ç°ä¾èµ–äºåº•å±‚æ“ä½œç³»ç»Ÿï¼Œå±äºè™šæ‹Ÿæœºçš„å®ç°çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒå¹¶æ²¡æœ‰ç»§æ‰¿ java.lang.ClassLoader ç±»ã€‚

* ç¤ºä¾‹ä¸€ï¼šè®©å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½æˆ‘ä»¬è‡ªå®šä¹‰çš„ç±»  
é€šè¿‡ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°ã€‚å¯åŠ¨ç±»åŠ è½½ä¼šå»åŠ è½½â€œ/Library/Java/JavaVirtualMachines/jdk1.8.0\_144.jdk/Contents/Home/jre/classesâ€ç›®å½•ä¸‹çš„å­—èŠ‚ç æ–‡ä»¶ã€‚  
å› æ­¤ï¼Œè¿™é‡Œï¼Œæˆ‘ä»¬å°† MyTest1.class æ”¾åˆ°è¿™ä¸ªç›®å½•ä¸‹ã€‚

> æ³¨æ„ï¼š  
> â€œ/Library/Java/JavaVirtualMachines/jdk1.8.0\_144.jdk/Contents/Home/jre/classesâ€ç›®å½•é»˜è®¤æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ˜¯æˆ‘è‡ªå·±åˆ›å»ºçš„ã€‚

~~~
# MyTest16 çš„å®ç°è§ä¸‹æ–‡
# MyTest18_1
public class MyTest18_1 {

    public static void main(String[] args) throws Exception {
        MyTest16 loader1 = new MyTest16("loader1");
        loader1.setPath("/Users/linling/Documents/code/shengsisyuan/");
        Class<?> clazz = loader1.loadClass("com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1");

        System.out.println("class : " + clazz.hashCode());
        System.out.println("class loader : " + clazz.getClassLoader());

    }
}
~~~

~~~
# æ§åˆ¶å°
class : 1360875712
class loader : null
~~~

ğŸ‘†ã€class loader : nullã€å¯è§ï¼ŒMyTest1 å·²ç»ç”±â€œå¯åŠ¨ç±»åŠ è½½å™¨â€åŠ è½½äº†ã€‚

<br>

* ç¤ºä¾‹äºŒ : ä¿®æ”¹â€œå¯åŠ¨ç±»åŠ è½½å™¨â€çš„è·¯å¾„  
å³ï¼Œä¿®æ”¹â€œsub.boot.class.pathâ€å‚æ•°å€¼çš„è·¯å¾„ã€‚

~~~
âœ  classes git:(master) âœ— java -Dsun.boot.class.path=./ com.bayern.shengsiyuan.jvm_lecture.lesson8.MyTest22
Error occurred during initialization of VM
java/lang/NoClassDefFoundError: java/lang/Object
~~~

åœ¨ Oracle çš„ Hotspot å®ç°ä¸­ï¼Œç³»ç»Ÿå±æ€§ sun.boot.class.path å¦‚æœä¿®æ”¹é”™äº†ï¼Œåˆ™è¿è¡Œä¼šå‡ºé”™ï¼Œæç¤ºå¦‚ä¸‹é”™è¯¯ä¿¡æ¯ï¼š

~~~
Error occurred during initialization of VM
java/lang/NoClassDefFoundError: java/lang/Object
~~~

<br>

### 3.2 æ‰©å±•ï¼ˆExtensionï¼‰ç±»åŠ è½½å™¨
å®ƒçš„çˆ¶åŠ è½½å™¨ä¸ºæ ¹ç±»åŠ è½½å™¨ã€‚å®ƒä» java.ext.dirs ç³»ç»Ÿå±æ€§æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»åº“ï¼Œæˆ–è€…ä» JDK çš„å®‰è£…ç›®å½•çš„ jre\lib\ext å­ç›®å½•ï¼ˆæ‰©å±•ç›®å½•ï¼‰ä¸‹åŠ è½½ç±»åº“ã€‚æ‰©å±•ç±»åŠ è½½å™¨æ˜¯çº¯ Java ç±»ï¼Œæ˜¯ java.lang.ClassLoader ç±»çš„å­ç±»ã€‚

* ç¤ºä¾‹ä¸€ï¼šä¿®æ”¹â€œæ‰©å±•ç±»åŠ è½½å™¨â€çš„åŠ è½½è·¯å¾„  
aï¼‰ä¿®æ”¹å‰ï¼š

~~~
# MyTest19
public class MyTest19 {

    public static void main(String[] args) {
        AESKeyGenerator aesKeyGenerator = new AESKeyGenerator();

        System.out.println(aesKeyGenerator.getClass().getClassLoader());
        System.out.println(MyTest19.class.getClassLoader());

    }
}
~~~

~~~
# æ§åˆ¶å°
sun.misc.Launcher$ExtClassLoader@4dc63996
sun.misc.Launcher$AppClassLoader@18b4aac2
~~~

<br>

bï¼‰ä¿®æ”¹â€œjava.ext.dirsâ€å±æ€§

~~~
# ç»ˆç«¯
âœ  classes git:(master) âœ— pwd
/Users/linling/Documents/code/IdeaWorkspace/shengsiyuan/jvm_lecture/out/production/classes

âœ  classes git:(master) âœ— java -Djava.ext.dirs=./ com.bayern.shengsiyuan.jvm_lecture.lesson7.MyTest19
Exception in thread "main" java.lang.NoClassDefFoundError: com/sun/crypto/provider/AESKeyGenerator
    at com.bayern.shengsiyuan.jvm_lecture.lesson7.MyTest19.main(MyTest19.java:8)
Caused by: java.lang.ClassNotFoundException: com.sun.crypto.provider.AESKeyGenerator
    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:335)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
~~~

<br>

* ç¤ºä¾‹äºŒ  

~~~
# MyTest22
public class MyTest22 {

    static {
        System.out.println("MyTest22 initializer");
    }

    public static void main(String[] args) {
        System.out.println(MyTest22.class.getClassLoader());

        System.out.println(MyTest1.class.getClassLoader());
    }
}
~~~

~~~
# ç»ˆç«¯
âœ  classes git:(master) âœ— pwd
/Users/linling/Documents/code/IdeaWorkspace/shengsiyuan/jvm_lecture/out/production/classes
âœ  classes git:(master) âœ— java -Djava.ext.dirs=./ com.bayern.shengsiyuan.jvm_lecture.lesson8.MyTest22
MyTest22 initializer
sun.misc.Launcher$AppClassLoader@73d16e93
sun.misc.Launcher$AppClassLoader@73d16e93
~~~
ğŸ‘†å³ä¾¿ä¿®æ”¹äº†â€œæ‰©å±•ç±»åŠ è½½å™¨â€çš„åŠ è½½è·¯å¾„ï¼ˆè¿™é‡Œéœ€è¦ç¡®ä¿â€œæ‰©å±•ç±»åŠ è½½å™¨â€å¯ä»¥æ‰¾åˆ°MyTest22.classï¼‰ï¼Œä½†ä¾æ—§æ˜¾ç¤ºæ˜¯â€œåº”ç”¨ç±»åŠ è½½å™¨â€åŠ è½½çš„MyTest22.classï¼ï¼

**è¿™æ˜¯å› ä¸ºï¼Œâ€œæ‰©å±•ç±»åŠ è½½å™¨â€æ‰€è¦åŠ è½½çš„æ–‡ä»¶ï¼ˆ.classæ–‡ä»¶ï¼‰è¿˜ä¸èƒ½ä»¥â€œ.classâ€çš„æ–‡ä»¶å­˜åœ¨ï¼Œè€Œå¿…é¡»ä»¥jaråŒ…çš„å½¢å¼å­˜åœ¨ï¼ˆå› æ­¤ä½ éœ€è¦å°† .class æ–‡ä»¶æ‰“æˆä¸€ä¸ªjaråŒ…ï¼‰ã€‚æ‰©å±•ç±»åŠ è½½å™¨ä¼šå°è¯•ä»jaråŒ…åŠ è½½ â€˜.classâ€™ æ–‡ä»¶ã€‚  
ä½†ï¼Œâ€œå¯åŠ¨ç±»åŠ è½½å™¨â€å’Œâ€œåº”ç”¨ç±»åŠ è½½å™¨â€æ²¡æœ‰è¿™æ ·çš„é™åˆ¶ã€‚ä»–ä»¬å¯ä»¥ä»ç›®å½•ä¸‹ç›´æ¥åŠ è½½â€™.classâ€™æ–‡ä»¶**

<br>

### 3.3 ç³»ç»Ÿï¼ˆSystemï¼‰ç±»åŠ è½½å™¨
ä¹Ÿç§°ä¸ºåº”ç”¨ç±»åŠ è½½å™¨ï¼Œå®ƒçš„çˆ¶åŠ è½½å™¨ä¸ºæ‰©å±•ç±»åŠ è½½å™¨ã€‚å®ƒä»ç¯å¢ƒå˜é‡ classpath æˆ–è€…ç³»ç»Ÿå±æ€§ java.class.path æ‰€æŒ‡å®šçš„ç›®å½•ä¸­åŠ è½½ç±»ï¼Œå®ƒæ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨çš„é»˜è®¤çˆ¶åŠ è½½å™¨ã€‚ç³»ç»Ÿç±»åŠ è½½å™¨æ˜¯çº¯ Java ç±»ï¼Œæ˜¯ java.lang.ClassLoader ç±»çš„å­ç±»ã€‚

* ç¤ºä¾‹ï¼šå°†è‡ªå®šä¹‰çš„ MyTest16ç±» åŠ è½½ä½œä¸ºâ€™ç³»ç»Ÿç±»åŠ è½½å™¨â€™

~~~
# MyTest16 çš„å®ç°è§ä¸‹æ–‡
# MyTest23
public class MyTest23 {

    public static void main(String[] args) {
    System.out.println(System.getProperty("java.system.class.loader"));
    System.out.println("-----------");
    System.out.println(ClassLoader.getSystemClassLoader());
    System.out.println("-----------");
    System.out.println(MyTest23.class.getClassLoader());
    }
}

# ç»ˆç«¯
classes git:(master) âœ— java -Djava.system.class.loader=com.bayern.shengsiyuan.jvm_lecture.lesson6.MyTest16 
com.bayern.shengsiyuan.jvm_lecture.lesson6.MyTest16
-----------
com.bayern.shengsiyuan.jvm_lecture.lesson6.MyTest16@4e25154f
-----------
sun.misc.Launcher$AppClassLoader@18b4aac2
~~~

æ³¨æ„ï¼Œå‰é¢è¯´â€œé»˜è®¤çš„ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆAppClassLoaderï¼‰â€çš„åŠ è½½è·¯å¾„æ˜¯â€œjava.class.pathâ€å±æ€§çš„å€¼ã€‚å½“ä½ ä¿®æ”¹äº†ç³»ç»Ÿç±»åŠ è½½å™¨ä¸ºä½ è‡ªå®šçš„ç±»åŠ è½½å™¨åï¼Œè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨å¹¶ä¸ä¼šå»åŠ è½½â€œjava.class.pathâ€å±æ€§å€¼æ‰€æ‰§è¡Œçš„è·¯å¾„ï¼ˆå› ä¸ºï¼Œè¿™æ˜¯åœ¨AppClassLoaderä»£ç ä¸­å»å®ç°çš„ï¼‰ã€‚å› æ­¤ï¼Œä½ ä¼šå‘ç°ï¼Œç±»è¿˜æ˜¯ä¼šç”±â€œAppClassLoaderâ€æ¥åŠ è½½ï¼Œå³ä¾¿æ­¤æ—¶å®ƒä¸å†æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨äº†ï¼ˆè€Œæ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨ï¼‰

<br>

### 3.4 ç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨
é™¤äº†è™šæ‹Ÿæœºè‡ªå¸¦çš„åŠ è½½å™¨å¤–ï¼Œç”¨æˆ·è¿˜å¯ä»¥å®šåˆ¶è‡ªå·±çš„ç±»åŠ è½½å™¨ã€‚Java æä¾›äº†æŠ½è±¡ç±» java.lang.ClassLoaderï¼Œæ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰ç±»çš„ç±»åŠ è½½å™¨éƒ½åº”è¯¥ç»§æ‰¿ ClassLoader ç±»ã€‚

~~~
# â€œç”¨æˆ·è‡ªå®šä¹‰ç±»åŠ è½½å™¨â€å®ä¾‹
public class MyTest16 extends ClassLoader {

    private String classLoaderName;

    private final String fileExtension = ".class";

    private String path;

    public MyTest16(String classLoaderName) {
        super();    // å°†ç³»ç»Ÿç±»åŠ è½½å™¨å½“åšè¯¥ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨
        this.classLoaderName = classLoaderName;
    }


    public MyTest16(ClassLoader parent, String classLoaderName) {
        super(parent);  // æ˜¾ç¤ºæŒ‡å®šè¯¥ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨
        this.classLoaderName = classLoaderName;
    }


    public MyTest16(ClassLoader parent) {
        super(parent);  // æ˜¾ç¤ºæŒ‡å®šè¯¥ç±»åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨
    }


    public void setPath(String path) {
        this.path = path;
    }


    private byte[] loadClassData(String name) {
        byte[] data = null;
        name = name.replace(".", "/");
        try(InputStream is = new FileInputStream(new File(path + name + this.fileExtension));
        ByteArrayOutputStream baos = new ByteArrayOutputStream();) {
            int ch;
            while (-1 != (ch = is.read())) {
                baos.write(ch);
            }
            data = baos.toByteArray();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return data;
    }


    @Override
    protected Class<?> findClass(String name) throws ClassNotFoundException {
        System.out.println("findClass invoked: " + name);
        System.out.println("class loader name : " + this.classLoaderName);
        byte[] data = loadClassData(name);
        return defineClass(name, data, 0, data.length);
    }

}
~~~

<br>

### 3.5 è·å– ClassLoader çš„å‡ ç§é€”å¾„

~~~
# è·å¾—å½“å‰ç±»çš„ ClassLoader
clazz.getClassLoader();

# è·å¾—å½“å‰çº¿ç¨‹ä¸Šä¸‹æ–‡çš„ ClassLoader
Thread.currentThread().getContextClassLoader()

# è·å¾—ç³»ç»Ÿçš„ ClassLoader
ClassLoader.getSystemClassLoader()

# è·å¾—è°ƒç”¨è€…çš„ ClassLoader
Reflection.getCallerClass()
~~~

> æ³¨æ„ï¼š  
> `è°ƒç”¨ ClassLoader ç±»çš„ loadClass æ–¹æ³•åŠ è½½ä¸€ä¸ªç±»ï¼Œå¹¶ä¸æ˜¯å¯¹ç±»çš„ä¸»åŠ¨ä½¿ç”¨ï¼Œä¸ä¼šå¯¼è‡´ç±»çš„åˆå§‹åŒ–ã€‚`

~~~
public class MyTest12 {

    public static void main(String[] args) throws Exception {
        ClassLoader loader = ClassLoader.getSystemClassLoader();
        Class<?> clazz = loader.loadClass("com.bayern.shengsiyuan.jvm_lecture.lesson4.CL");
        System.out.println(clazz);
    }
}


class CL {
    static {
        // è‹¥ CL ç±»è¢«åˆå§‹åŒ–ï¼Œä¸‹é¢çš„è¯­å¥ä¼šè¢«æ‰“å°ã€‚
        System.out.println("Class CL");
    }
}

~~~

~~~
# æ§åˆ¶å°
class com.bayern.shengsiyuan.jvm_lecture.lesson4.CL
~~~

å¯è§ CL ç±»å¹¶æ²¡æœ‰è¢«åˆå§‹åŒ–ã€‚

<br>

### 3.6 æ•°ç»„ ä¸ ç±»åŠ è½½å™¨
å¯¹äºæ•°ç»„ç±»è€Œè¨€ï¼Œæƒ…å†µå°±æœ‰æ‰€ä¸åŒï¼Œæ•°ç»„ç±»æœ¬èº«ä¸é€šè¿‡ç±»åŠ è½½å™¨åˆ›å»ºï¼Œå®ƒæ˜¯ç”±Javaè™šæ‹Ÿæœºåœ¨è¿è¡Œæ—¶ç›´æ¥åˆ›å»ºçš„ï¼ˆâ€˜æ•°ç»„â€™çš„çˆ¶ç±»æ˜¯â€™Objectâ€™ï¼‰ã€‚ä½†æ•°ç»„ç±»ä¸ç±»åŠ è½½å™¨ä»ç„¶æœ‰å¾ˆå¯†åˆ‡çš„å…³ç³»ï¼Œå› ä¸ºæ•°ç»„ç±»çš„å…ƒç´ ç±»å‹ï¼ˆElement Typeï¼ŒæŒ‡çš„æ˜¯æ•°ç»„å»æ‰æ‰€æœ‰ç»´åº¦çš„ç±»å‹ï¼‰æœ€ç»ˆæ˜¯è¦é ç±»åŠ è½½å™¨å»åˆ›å»ºã€‚  
å¦‚æœæ•°ç»„çš„ç»„ä»¶ç±»å‹ï¼ˆComponent Typeï¼ŒæŒ‡çš„æ˜¯æ•°ç»„å»æ‰ä¸€ä¸ªç»´åº¦çš„ç±»å‹ï¼‰æ˜¯å¼•ç”¨ç±»å‹ï¼Œé‚£å°±é€’å½’é‡‡ç”¨æœ¬ä¸­å®šä¹‰çš„åŠ è½½è¿‡ç¨‹å»åŠ è½½è¿™ä¸ªç»„ä»¶ç±»å‹ï¼Œæ•°ç»„Cå°†åœ¨åŠ è½½è¯¥ç»„ä»¶ç±»å‹çš„ç±»åŠ è½½å™¨çš„ç±»åç§°ç©ºé—´ä¸Šè¢«æ ‡è¯†ã€‚  
å¦‚æœæ•°ç»„çš„ç»„ä»¶ç±»å‹ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼ˆä¾‹å¦‚int[]æ•°ç»„ï¼‰ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠŠæ•°ç»„Cæ ‡è®°ä¸ºä¸å¼•å¯¼ç±»åŠ è½½å™¨å…³è”ã€‚  

~~~
public class MyTest15 {

    public static void main(String[] args) {
        String[][] strings = new String[2][];
        System.out.println(strings.getClass().getClassLoader());

        System.out.println("=============================");

        MyTest15[] myTest15s = new MyTest15[2];
        System.out.println(myTest15s.getClass().getClassLoader());

        System.out.println("=============================");

        int[] ints = new int[2];
        System.out.println(ints.getClass().getClassLoader());
    }
}

# æ§åˆ¶å°
null
=============================
sun.misc.Launcher$AppClassLoader@18b4aac2
=============================
null
~~~

æ‰€ä»¥ï¼Œè¿™é‡Œã€‚strings.getClass().getClassLoader() å’Œ ints.getClass().getClassLoader() éƒ½è¿”å› nullï¼Œæ ‡ç­¾å…¶éƒ½æ˜¯é€šè¿‡â€œå¼•å¯¼ç±»åŠ è½½å™¨â€åŠ è½½çš„ã€‚

> æ³¨æ„ ï¼š  
> å³ä¾¿æ˜¯å¤šç»´æ•°ç»„ï¼Œå…¶ getClass().getClassLoader() è¿”å›çš„ä¹Ÿæ˜¯ï¼ŒåŠ è½½å…ƒç´ ç±»çš„ç±»åŠ è½½å™¨ã€‚

<br>

### 3.7 ç±»åŠ è½½å™¨ä¹‹é—´çš„åŠ è½½å…³ç³»ï¼ˆåœ¨HotSpotä¸­ï¼‰

`ç³»ç»Ÿçš„ç±»ï¼ˆé™¤äº†æ•°ç»„ï¼Œæ•°ç»„æ˜¯ç”±JVMåˆ›å»ºçš„ï¼‰ä¸€å®šæ˜¯ç”±ç±»åŠ è½½å™¨æ¥å»åŠ è½½çš„ã€‚`  
â€œæ‰©å±•ç±»åŠ è½½å™¨â€å’Œâ€œåº”ç”¨ç±»åŠ è½½å™¨â€ä»¥åŠâ€œè‡ªå®šä¹‰ç±»åŠ è½½å™¨â€éƒ½æ˜¯ç”±â€œå¯åŠ¨ç±»åŠ è½½å™¨â€åŠ è½½çš„ï¼Œå…·ä½“è¯¦è§[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œä» sun.misc.Launcher ç±»æºç æ·±å…¥æ¢ç´¢ ClassLoaderã€](/programming_blog/2019/11/07/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ä»-sun.misc.Launcher-ç±»æºç æ·±å…¥æ¢ç´¢-ClassLoader/)    
â€œå¯åŠ¨ç±»åŠ è½½å™¨â€æ˜¯C++ä»£ç ï¼Œå¹¶ä¸”å†…å»ºä¸JVMï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒæ˜¯JVMçš„ä¸€éƒ¨åˆ†ã€‚è€Œå…¶ä»–ç±»åŠ è½½å™¨éƒ½æ˜¯Javaä»£ç   
å†…å»ºäºJVMä¸­çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¼šåŠ è½½java.lang.ClassLoaderä»¥åŠå…¶ä»–çš„Javaå¹³å°ç±»ï¼Œ  
å½“JVMå¯åŠ¨æ—¶ï¼Œä¸€å—ç‰¹æ®Šçš„æœºå™¨ç ä¼šè¿è¡Œï¼Œå®ƒä¼šåŠ è½½æ‰©å±•ç±»åŠ è½½å™¨ä¸ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œ  
è¿™å—ç‰¹æ®Šçš„æœºå™¨ç å«åš'å¯åŠ¨ç±»åŠ è½½å™¨'ï¼ˆBootstrapï¼‰ã€‚  

å¯åŠ¨ç±»åŠ è½½å™¨å¹¶ä¸æ˜¯Javaç±»ï¼Œè€Œå…¶ä»–çš„åŠ è½½å™¨åˆ™éƒ½æ˜¯Javaç±»ï¼Œ  
å¯åŠ¨ç±»åŠ è½½å™¨æ˜¯ç‰¹å®šäºå¹³å°çš„æœºå™¨æŒ‡ä»¤ï¼Œå®ƒè´Ÿè´£å¼€å¯æ•´ä¸ªåŠ è½½è¿‡ç¨‹ã€‚

æ‰€æœ‰ç±»åŠ è½½å™¨ï¼ˆé™¤äº†å¯åŠ¨ç±»åŠ è½½å™¨ï¼‰éƒ½è¢«å®ç°ä¸ºJavaç±»ï¼Œä¸è¿‡ï¼Œæ€»å½’è¦æœ‰ä¸€ä¸ªç»„ä»¶æ¥åŠ è½½ç¬¬ä¸€ä¸ªJavaç±»åŠ è½½å™¨ï¼Œä»è€Œè®©æ•´ä¸ªåŠ è½½è¿‡ç¨‹èƒ½å¤Ÿé¡ºåˆ©è¿›è¡Œä¸‹å»ï¼ŒåŠ è½½ç¬¬ä¸€ä¸ªçº¯Javaç±»åŠ è½½å™¨å°±æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨çš„èŒè´£ã€‚

å¯åŠ¨ç±»åŠ è½½å™¨è¿˜ä¼šè´Ÿè´£åŠ è½½ä¾›JREæ­£å¸¸è¿è¡Œæ‰€éœ€è¦çš„åŸºæœ¬ç»„ä»¶ï¼Œè¿™åŒ…æ‹¬java.utilä¸java.langåŒ…ä¸­çš„ç±»ã€‚

<br>

## å››ï¼Œæ·±å…¥â€œçˆ¶äº²å§”æ‰˜æœºåˆ¶â€ï¼ˆåŒäº²å§”æ´¾æ¨¡å‹ï¼‰  
### 4.1 â€œçˆ¶äº²å§”æ‰˜æœºåˆ¶â€æ˜¯ä»€ä¹ˆï¼Ÿ
é™¤äº†é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨å¤–ï¼Œå…¶ä½™çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™é‡Œç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸ä¼šä»¥ç»§æ‰¿ï¼ˆInheritanceï¼‰çš„å…³ç³»æ¥å®ç°ï¼Œè€Œæ˜¯éƒ½ä½¿ç”¨ç»„åˆï¼ˆCompositionï¼‰å…³ç³»æ¥å¤ç”¨çˆ¶åŠ è½½å™¨çš„ä»£ç ã€‚ç±»åŠ è½½å™¨ä¹‹é—´çš„è¿™ç§å±‚æ¬¡å…³ç³»ï¼Œç§°ä¸ºç±»åŠ è½½å™¨çš„åŒäº²å§”æ´¾æ¨¡å‹ï¼ˆParents Delegation Modelï¼‰ã€‚

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ol3iy7hmj303j05tq2w.jpg)

~~~
public class MyTest13 {

    public static void main(String[] args) {
        ClassLoader classLoader = ClassLoader.getSystemClassLoader();
        System.out.println(classLoader);

        while (null != classLoader) {
            classLoader = classLoader.getParent();
            System.out.println(classLoader);
        }
    }
}
~~~

~~~
# æ§åˆ¶å°
sun.misc.Launcher$AppClassLoader@18b4aac2
sun.misc.Launcher$ExtClassLoader@60e53b93
null
~~~


åŒäº²å§”æ´¾æ¨¡å¼å¹¶ä¸æ˜¯ä¸€ä¸ªå¼ºåˆ¶æ€§çš„çº¦æŸæ¨¡å‹ï¼Œè€Œæ˜¯Javaè®¾è®¡è€…æ¨èç»™å¼€å‘è€…çš„ä¸€ç§ç±»åŠ è½½å™¨å®ç°æ–¹å¼ã€‚

åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œè¿‡ç¨‹æ˜¯ï¼šå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å»å°è¯•åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰çš„åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“çˆ¶åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆè¿™ä¸ªåŠ è½½è¯·æ±‚ï¼ˆå®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€çš„ç±»ï¼‰æ—¶ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ã€‚

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ol4izmo5j30d8095my3.jpg)  
è‡ªåº•å‘ä¸Šæ£€æµ‹ç±»æ˜¯å¦å·²ç»åŠ è½½ï¼Œè‡ªé¡¶å‘ä¸‹å°è¯•åŠ è½½ç±»

åŒäº²å§”æ‰˜æœºåˆ¶æ˜¯HotSpot VMé»˜è®¤è‡ªå¸¦çš„æœºåˆ¶ï¼Œä½†å¹¶ä¸æ˜¯æ‰€æœ‰ç¯å¢ƒä¸‹ç±»åŠ è½½å™¨éƒ½éµå¾ªç€è¿™ç§å§”æ‰˜æœºåˆ¶ã€‚æ¯”å¦‚ï¼ŒOSGIæ ‡å‡†å°±æ‰“ç ´äº†ç±»åŠ è½½å™¨çš„è¿™ç§åŒäº²å§”æ‰˜æœºåˆ¶ï¼

<br>

### 4.2 ç±»åŠ è½½å™¨çš„åŒäº²å§”æ‰˜æ¨¡å‹çš„å¥½å¤„
1. å¯ä»¥ç¡®ä¿Javaæ ¸å¿ƒåº“ç±»å‹å®‰å…¨ï¼ˆæ ¸å¿ƒåº“ï¼šå³ï¼ŒJDKè‡ªå¸¦çš„åŸºç¡€ç±»ï¼‰ï¼šæ‰€æœ‰çš„Javaåº”ç”¨éƒ½è‡³å°‘ä¼šå¼•ç”¨java.lang.Objectç±»ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨è¿è¡ŒæœŸï¼Œjava.lang.Objectè¿™ä¸ªç±»ä¼šè¢«åŠ è½½åˆ°Javaè™šæ‹Ÿæœºä¸­ï¼›å¦‚æœè¿™ä¸ªåŠ è½½è¿‡ç¨‹æ˜¯ç”±Javaåº”ç”¨è‡ªå·±çš„ç±»åŠ è½½å™¨æ‰€å®Œæˆçš„ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½å°±ä¼šåœ¨JVMä¸­å­˜åœ¨å¤šä¸ªç‰ˆæœ¬çš„java.lang.Objectç±»ï¼Œè€Œä¸”è¿™äº›ç±»ä¹‹é—´è¿˜æ˜¯ä¸å…¼å®¹çš„ï¼Œç›¸äº’ä¸å¯è§çš„ï¼ˆæ­£æ˜¯å‘½åç©ºé—´åœ¨å‘æŒ¥ç€ä½œç”¨ï¼‰ã€‚å€ŸåŠ©äºåŒäº²å§”æ‰˜æœºåˆ¶ï¼ŒJavaæ ¸å¿ƒç±»åº“ä¸­çš„ç±»çš„åŠ è½½å·¥ä½œéƒ½æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨æ¥ç»Ÿä¸€å®Œæˆï¼Œä»è€Œç¡®ä¿äº†Javaåº”ç”¨æ‰€ä½¿ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ªç‰ˆæœ¬çš„Javaæ ¸å¿ƒç±»åº“ï¼Œä»–ä»¬ä¹‹é—´æ˜¯ç›¸äº’å…¼å®¹çš„ã€‚
2. å¯ä»¥ç¡®ä¿Javaæ ¸å¿ƒç±»åº“æ‰€æä¾›çš„ç±»ä¸ä¼šè¢«è‡ªå®šä¹‰çš„ç±»æ‰€æ›¿ä»£ã€‚ï¼ˆå› ä¸ºï¼ŒåŒäº²å§”æ´¾çš„æœºåˆ¶ä¼šç¡®ä¿ Javaæ ¸å¿ƒç±»åº“æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œè¿™æ ·å°±æ— æ³•é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½äº†ã€‚åŒæ—¶ï¼ŒJVMä¹Ÿæœ‰ç›¸åº”çš„æ£€æµ‹æ¥å¼ºåˆ¶Javaæ ¸å¿ƒç±»åº“åªèƒ½ç”±å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œå³ä¾¿ä½ å¼ºåˆ¶ä¿®æ”¹äº†å¯åŠ¨ç±»åŠ è½½å™¨çš„åŠ è½½è·¯å¾„ï¼‰
3. ä¸åŒçš„ç±»åŠ è½½å™¨å¯ä»¥ä¸ºç›¸åŒåç§°ï¼ˆbinary nameï¼‰çš„ç±»åˆ›å»ºé¢å¤–çš„å‘½åç©ºé—´ï¼Œç›¸åŒåç§°çš„ç±»å¯ä»¥å¹¶å­˜åœ¨Javaè™šæ‹Ÿæœºä¸­ï¼Œåªéœ€è¦ç”¨ä¸åŒçš„ç±»åŠ è½½å™¨æ¥åŠ è½½ä»–ä»¬å³å¯ã€‚ä¸åŒç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ä¹‹é—´æ˜¯ä¸å…¼å®¹çš„ï¼Œè¿™å°±ç›¸å½“äºåœ¨Javaè™šæ‹Ÿæœºå†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªåˆä¸€ä¸ªç›¸äº’éš”ç¦»çš„Javaç±»ç©ºé—´ï¼Œè¿™ç±»æŠ€æœ¯åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½å¾—åˆ°äº†å®é™…åº”ç”¨ã€‚


Tomcat ç­‰webåº”ç”¨æ¡†æ¶ï¼Œå¹¶æ²¡æœ‰ä½¿ç”¨é»˜è®¤çš„åŒäº²å§”æ´¾æœºåˆ¶ï¼Œè€Œæ˜¯ä½¿ç”¨äº†è‡ªå·±çš„ç±»åŠ è½½æœºåˆ¶çš„å®ç°æ–¹å¼ã€‚å…·ä½“å¯è§ï¼š[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œæ¡ˆä¾‹åˆ†æï¼šTomcat ç±»åŠ è½½å™¨æ¶æ„ã€](/programming_blog/2019/11/08/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-æ¡ˆä¾‹åˆ†æ-Tomcat-ç±»åŠ è½½å™¨æ¶æ„/)

<br>

### 4.3 â€œå®šä¹‰ç±»åŠ è½½å™¨â€ ä¸ â€œåˆå§‹ç±»åŠ è½½å™¨â€
è‹¥æœ‰ä¸€ä¸ªç±»åŠ è½½å™¨èƒ½å¤ŸæˆåŠŸåŠ è½½ Test ç±»ï¼Œé‚£ä¹ˆè¿™ä¸ªç±»åŠ è½½å™¨è¢«ç§°ä¸ºâ€œå®šä¹‰ç±»åŠ è½½å™¨â€ï¼Œæ‰€æœ‰èƒ½æˆåŠŸè¿”å› Class å¯¹è±¡å¼•ç”¨çš„ç±»åŠ è½½å™¨ï¼ˆåŒ…æ‹¬å®šä¹‰ç±»åŠ è½½å™¨ï¼‰éƒ½è¢«æˆä¸ºâ€œåˆå§‹ç±»åŠ è½½å™¨â€ã€‚  
ğŸ‘†è¿™ä¸ªæ¦‚å¿µæ˜¯åŸºäºâ€œç±»çš„çˆ¶äº²å§”æ‰˜æœºåˆ¶â€çš„ã€‚  
ä¹Ÿå°±æ˜¯è¯´ï¼ŒçœŸæ­£è´Ÿè´£æˆåŠŸåŠ è½½è¿™ä¸ªç±»çš„åŠ è½½å™¨ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå®šä¹‰ç±»åŠ è½½å™¨â€ã€‚  
æ¥å—ç±»åŠ è½½è¯·æ±‚ï¼Œé€šè¿‡è°ƒç”¨loadClassæ¥å¼€å¯ç±»çš„åŠ è½½è¿‡ç¨‹çš„åŠ è½½å™¨è¢«ç§°ä¸ºâ€œåˆå§‹ç±»åŠ è½½å™¨â€ã€‚  

ä¸¤ç§ç±»åŠ è½½å™¨çš„å…³è”ä¹‹å¤„åœ¨äºï¼šä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªç±»çš„å®šä¹‰åŠ è½½å™¨æ˜¯å®ƒå¼•ç”¨çš„å…¶å®ƒç±»çš„åˆå§‹åŠ è½½å™¨ã€‚ï¼ˆæœ‰ç‚¹æ™¦æ¶©ï¼Œè¿™å¥è¯å¯ä»¥ä¸¾ä¾‹è¯´æ˜ï¼šClassAçš„ç±»åŠ è½½å™¨ä¸ºClassLoaderAï¼ŒClassLoaderBæ˜¯ClassLoaderAçˆ¶ç±»åŠ è½½å™¨ï¼Œé‚£ä¹ˆå½“ClassLoaderAåˆå§‹åŠ è½½ClassAæ—¶ï¼Œç”±äºç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼ï¼Œåˆ™ä¼šè°ƒç”¨çˆ¶ç±»åŠ è½½å™¨ClassLoaderBæ¥åŠ è½½ClassAï¼Œæ‰€ä»¥ClassLoaderAå«åšClassAçš„åˆå§‹åŠ è½½å™¨ï¼Œè€ŒClassLoaderBå«åšClassAçš„å®šä¹‰åŠ è½½å™¨ï¼Œç„¶è€ŒClassAä¸­å¼•ç”¨äº†ClassCï¼Œé‚£ä¹ˆå½“åŠ è½½å™¨ClassLoaderBåŠ è½½ClassAæ—¶ï¼Œä¼šåˆå§‹åŠ è½½ClassCï¼Œæ‰€ä»¥ClassLoaderBåˆå«åšClassCçš„åˆå§‹åŠ è½½å™¨ï¼Œåˆç”±äºç±»åŠ è½½å™¨çš„ä»£ç†æ¨¡å¼ï¼Œåˆ™ä¼šè°ƒç”¨ClassLoaderBçš„çˆ¶ç±»åŠ è½½å™¨--ç³»ç»Ÿç±»åŠ è½½å™¨æ¥å®šä¹‰ClassCï¼Œæ‰€ä»¥æœ€åç³»ç»Ÿç±»åŠ è½½å™¨å«ä½œClassCçš„å®šä¹‰åŠ è½½å™¨ï¼‰ã€‚

<br>

### 4.4 å‘½åç©ºé—´
æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ï¼Œå‘½åç©ºé—´ç”±è¯¥åŠ è½½å™¨åŠæ‰€æœ‰çˆ¶åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ç»„æˆã€‚  
åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´ä¸­ï¼Œä¸ä¼šå‡ºç°ç±»çš„å®Œæ•´åå­—ï¼ˆåŒ…æ‹¬ç±»çš„åŒ…åï¼‰ç›¸åŒçš„ä¸¤ä¸ªç±»  
åœ¨ä¸åŒçš„å‘½åç©ºé—´ä¸­ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°ç±»çš„å®Œæ•´åå­—ï¼ˆåŒ…æ‹¬ç±»çš„åŒ…åï¼‰ç›¸åŒçš„ä¸¤ä¸ªç±»  

~~~
# ä¿®æ”¹ MyTest16 ç±»çš„ main æ–¹æ³•
public static void main(String[] args) throws Exception {
    MyTest16 loader1 = new MyTest16("loader1");
    loader1.setPath("/Users/linling/Documents/code/shengsisyuan/");
	
    Class<?> clazz = loader1.loadClass("com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1");
    System.out.println("class : " + clazz.hashCode());
    Object object = clazz.newInstance();
    System.out.println(object);
    System.out.println();
	
	
    loader1 = new MyTest16("loader1");
    loader1.setPath("/Users/linling/Documents/code/shengsisyuan/");
    clazz = loader1.loadClass("com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1");
    System.out.println("class : " + clazz.hashCode());
    object = clazz.newInstance();
    System.out.println(object);
}
~~~

**aï¼‰æ³¨æ„ï¼Œå‰æï¼Œå°†CLASSPATHä¸‹çš„â€œMyTest1.classâ€ä¿ç•™ï¼ï¼ï¼**  
ï¼ˆ"/Users/linling/Documents/code/shengsisyuan/â€œç›®å½•ä¸‹å­˜åœ¨æ‰€éœ€çš„æ‰€æœ‰å­—èŠ‚ç æ–‡ä»¶ï¼‰  

~~~
# æ§åˆ¶å°
class : 1625635731
com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1@5e2de80c


class : 1625635731
com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1@1d44bcfa
~~~

é¦–å…ˆï¼Œclasså¯¹è±¡çš„hashcodeä¸€æ ·ï¼Œè¯´æ˜ç±»åªä¼šè¢«åŠ è½½ä¸€æ¬¡ï¼Œå‰é¢è¢«åŠ è½½è¿‡åï¼Œåé¢å°±ç›´æ¥ç”¨äº†ï¼ï¼  
å…¶æ¬¡ï¼Œè¯´æ˜æ­¤æ—¶MyTest1ç±»æ˜¯ç”±ç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½çš„ã€‚


**bï¼‰æ³¨æ„ï¼Œå‰æï¼Œå°†CLASSPATHä¸‹çš„â€œMyTest1.classâ€åˆ é™¤ï¼ï¼ï¼**  
ï¼ˆ"/Users/linling/Documents/code/shengsisyuan/â€œç›®å½•ä¸‹å­˜åœ¨æ‰€éœ€çš„æ‰€æœ‰å­—èŠ‚ç æ–‡ä»¶ï¼‰

~~~
# æ§åˆ¶å°
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1
class loader name : loader1
class : 491044090
com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1@266474c2


findClass invoked: com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1
class loader name : loader1
class : 1725154839
com.bayern.shengsiyuan.jvm_lecture.lesson1.MyTest1@63947c6b
~~~

è¿™é‡Œï¼ŒMyTest1è¢«åŠ è½½äº†2æ¬¡ï¼Œå› ä¸ºloader1å’Œloader2çš„çˆ¶åŠ è½½å™¨éƒ½æ˜¯ç³»ç»Ÿç±»åŠ è½½å™¨ï¼Œè€Œåœ¨ç³»ç»Ÿç±»åŠ è½½å™¨ä¸­æ˜¯æ— æ³•æŸ¥è¯¢åˆ°MyTest1çš„ï¼Œæ‰€ä»¥åˆ†åˆ«ç”±è‡ªå®šçš„ç±»åŠ è½½å™¨loader1å’Œloader2è¿›è¡ŒMyTest1çš„åŠ è½½ã€‚

<br>

### 4.5 ä¸åŒç±»åŠ è½½å™¨çš„å‘½åç©ºé—´çš„å…³ç³»
aï¼‰åŒä¸€ä¸ªå‘½åç©ºé—´å†…çš„ç±»æ˜¯ç›¸äº’å¯è§çš„ã€‚  
bï¼‰å­åŠ è½½å™¨çš„å‘½åç©ºé—´åŒ…å«æ‰€æœ‰çˆ¶åŠ è½½å™¨çš„å‘½åç©ºé—´ã€‚å› æ­¤ç”±å­åŠ è½½å™¨åŠ è½½çš„ç±»èƒ½çœ‹è§çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»ã€‚ä¾‹å¦‚ï¼Œç³»ç»Ÿç±»åŠ è½½å™¨åŠ è½½çš„ç±»èƒ½çœ‹è§æ ¹ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ã€‚  
cï¼‰ç”±çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»ä¸èƒ½çœ‹è§å­åŠ è½½å™¨åŠ è½½çš„ç±»ã€‚  
å¦‚æœä¸¤ä¸ªåŠ è½½å™¨ä¹‹é—´æ²¡æœ‰ç›´æ¥æˆ–é—´æ¥çš„çˆ¶å­å…³ç³»ï¼Œé‚£ä¹ˆå®ƒä»¬å„è‡ªåŠ è½½çš„ç±»ç›¸äº’ä¸å¯è§ã€‚

> æ³¨æ„ï¼š  
> è¿™é‡Œè¯´æ˜¯â€œå¯è§çš„â€ï¼Œä½†èƒ½ä¸èƒ½è®¿é—®æ˜¯ç”±â€œè®¿é—®ä¿®é¥°ç¬¦â€å†³å®šçš„ã€‚

~~~
# MyTest17
public class MyTest17 extends ClassLoader {

    public static void main(String[] args) throws Exception {
        MyTest16 loader1 = new MyTest16("loader1â€);
        loader1.setPath("/Users/linling/Documents/code/shengsisyuan/");
        Class<?> clazz = loader1.loadClass("com.bayern.shengsiyuan.jvm_lecture.lesson7.MySample");
        System.out.println("class : " + clazz.hashCode());

        // å¦‚æœæ³¨é‡Šæ‰è¯¥è¡Œï¼Œé‚£ä¹ˆå¹¶ä¸ä¼šå®ä¾‹åŒ– MySample å¯¹è±¡ï¼Œå³ MySample æ„é€ ä¸ä¼šè¢«è°ƒç”¨ã€‚
        // å› æ­¤ä¸ä¼šå®ä¾‹åŒ– MyCat å¯¹è±¡ï¼Œå³æ²¡æœ‰å¯¹ MyCat è¿›è¡Œä¸»åŠ¨ä½¿ç”¨ã€‚
        Object obj = clazz.newInstance();


    }
}

# MySample
public class MySample {

    public MySample() {
        System.out.println("MySample is loaded by : " + this.getClass().getClassLoader());
        new MyCat();
    }
}

# MyCat
public class MyCat {

    public MyCat() {
        System.out.println("MyCat is loaded by : " + this.getClass().getClassLoader());
    }
    
}
~~~

a) ç›´æ¥è¿è¡Œï¼ˆclassPath ä¸‹çš„ MySample.classã€MyCat.class å¹¶æ²¡æœ‰åˆ é™¤ï¼‰  

~~~
# æ§åˆ¶å°
class : 1360875712
MySample is loaded by : sun.misc.Launcher$AppClassLoader@18b4aac2
MyCat is loaded by : sun.misc.Launcher$AppClassLoader@18b4aac2
~~~

bï¼‰å°† classPath ä¸‹çš„ MySample.classã€MyCat.class åˆ é™¤å  
ï¼ˆ"/Users/linling/Documents/code/shengsisyuan/â€œç›®å½•ä¸‹å­˜åœ¨æ‰€éœ€çš„æ‰€æœ‰å­—èŠ‚ç æ–‡ä»¶ï¼‰ï¼š

~~~
# æ§åˆ¶å°
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.lesson7.MySample
class loader name : loader1
class : 1580066828
MySample is loaded by : [loader1]
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.lesson7.MyCat
class loader name : loader1
MyCat is loaded by : [loader1]
~~~

ğŸ‘†MySample.class å’Œ MyCat.class éƒ½ç”± loader1 åŠ è½½å™¨åŠ è½½äº†ã€‚

cï¼‰ä»…å°† classPath ä¸‹çš„ MyCat.class åˆ é™¤åï¼ˆ"/Users/linling/Documents/code/shengsisyuan/â€œç›®å½•ä¸‹å­˜åœ¨æ‰€éœ€çš„æ‰€æœ‰å­—èŠ‚ç æ–‡ä»¶ï¼‰ï¼š  

~~~
# æ§åˆ¶å°
class : 1360875712
MySample is loaded by : sun.misc.Launcher$AppClassLoader@18b4aac2
Exception in thread "main" java.lang.NoClassDefFoundError: com/bayern/shengsiyuan/jvm_lecture/lesson7/MyCat
    at com.bayern.shengsiyuan.jvm_lecture.lesson7.MySample.<init>(MySample.java:8)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
    at java.lang.Class.newInstance(Class.java:442)
    at com.bayern.shengsiyuan.jvm_lecture.lesson7.MyTest17_1.main(MyTest17_1.java:15)
Caused by: java.lang.ClassNotFoundException: com.bayern.shengsiyuan.jvm_lecture.lesson7.MyCat
    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:335)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
    ... 7 more
~~~

å› ä¸ºï¼Œæ­¤æ—¶ MySample æ˜¯ç”± åº”ç”¨ç±»åŠ è½½å™¨ åŠ è½½çš„ï¼Œè€Œåº”ç”¨ç±»åŠ è½½å™¨ï¼ˆåŠå…¶çˆ¶ç±»åŠ è½½å™¨ï¼‰æ— æ³•åŠ è½½ MyCatã€‚  

dï¼‰ä¿®æ”¹ï¼šMyCat ä¸­æ·»åŠ å¯¹MySample Class å¯¹è±¡çš„å¼•ç”¨ã€‚åŒæ—¶ä»…å°† classPath ä¸‹çš„ MySample.class åˆ é™¤  
ï¼ˆ"/Users/linling/Documents/code/shengsisyuan/â€œç›®å½•ä¸‹å­˜åœ¨æ‰€éœ€çš„æ‰€æœ‰å­—èŠ‚ç æ–‡ä»¶ï¼‰ï¼š

~~~
# MyCat
public class MyCat {

    public MyCat() {
        System.out.println("MyCat is loaded by : " + this.getClass().getClassLoader());
        System.out.println("from MyCat : " + MySample.class);
    }

}
~~~

~~~
# æ§åˆ¶å°
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.lesson7.MySample
class loader name : loader1
class : 1580066828
MySample is loaded by : [loader1]
MyCat is loaded by : sun.misc.Launcher$AppClassLoader@18b4aac2
Exception in thread "main" java.lang.NoClassDefFoundError: com/bayern/shengsiyuan/jvm_lecture/lesson7/MySample
    at com.bayern.shengsiyuan.jvm_lecture.lesson7.MyCat.<init>(MyCat.java:8)
    at com.bayern.shengsiyuan.jvm_lecture.lesson7.MySample.<init>(MySample.java:8)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)
    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)
    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)
    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)
    at java.lang.Class.newInstance(Class.java:442)
    at com.bayern.shengsiyuan.jvm_lecture.lesson7.MyTest17_1.main(MyTest17_1.java:15)
Caused by: java.lang.ClassNotFoundException: com.bayern.shengsiyuan.jvm_lecture.lesson7.MySample
    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:335)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
    ... 8 more
~~~

MyCat å’Œ MySample æ˜¯ç”±ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚MyCat ä¸ MySampleçš„å‘½åç©ºé—´ä¸åŒï¼Œä¸” MyCat çš„å‘½åç©ºé—´å±‚çº§é«˜äºMySample çš„å‘½åç©ºé—´ã€‚  
MyCat æ˜¯ç”±ç³»ç»Ÿç±»ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œå®ƒæ˜¯çœ‹ä¸åˆ°å­åŠ è½½å™¨ï¼ˆè‡ªå®šä¹‰åŠ è½½å™¨loader1ï¼‰æ‰€åŠ è½½çš„ç±»çš„ï¼

<br>

* å‘½åç©ºé—´ç»å…¸ç¤ºä¾‹  
å°† classPath ä¸‹ MyPerson.class æ–‡ä»¶åˆ é™¤  

~~~
# MyPerson
public class MyPerson {

    private MyPerson myPerson;

    public void setMyPerson(Object object) {
        this.myPerson = (MyPerson)object;
    }
}


# MyTest21
public class MyTest21 {

    public static void main(String[] args) throws Exception {
        MyTest16 loader1 = new MyTest16("loader1");
        MyTest16 loader2 = new MyTest16("loader2");

        loader1.setPath("/Users/linling/Documents/code/shengsisyuan/");
        loader2.setPath("/Users/linling/Documents/code/shengsisyuan/");

        Class<?> clazz1 = loader1.loadClass("com.bayern.shengsiyuan.jvm_lecture.lesson7.MyPerson");
        Class<?> clazz2 = loader2.loadClass("com.bayern.shengsiyuan.jvm_lecture.lesson7.MyPerson");

        System.out.println(clazz1 == clazz2);

        Object object1 = clazz1.newInstance();
        Object object2 = clazz2.newInstance();

        Method method = clazz1.getMethod("setMyPerson", MyPerson.class);
        method.invoke(object1, object2);
    }
}
~~~

~~~
# æ§åˆ¶å°
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson
class loader name : loader1
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson
class loader name : loader2
Exception in thread "main" false
java.lang.reflect.InvocationTargetException
    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.lang.reflect.Method.invoke(Method.java:498)
    at com.bayern.shengsiyuan.jvm_lecture.classload.lesson8.MyTest21.main(MyTest21.java:36)
Caused by: java.lang.ClassCastException: com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson cannot be cast to com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson
    at com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson.setMyPerson(MyPerson.java:8)
    ... 5 more
~~~

**ğŸ‘†ç±»å‹è½¬æ¢å¼‚å¸¸ï¼ï¼ï¼**å¹¶ä¸”ï¼Œclazz1 != clazz2  
æ­¤å¤„ï¼Œclazz1 å’Œ clazz2 åˆ†åˆ«ç”±å„è‡ªçš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½çš„ã€‚å› æ­¤ï¼Œclazz1 å’Œ clazz2 å¤„äºä¸åŒçš„å‘½åç©ºé—´ä¸­ã€‚  
æ¯ä¸ªç±»åŠ è½½å™¨éƒ½æœ‰è‡ªå·±çš„å‘½åç©ºé—´ã€‚å‘½åç©ºé—´ç”±è¯¥åŠ è½½å™¨åŠæ‰€æœ‰çˆ¶ç±»åŠ è½½å™¨æ‰€åŠ è½½çš„ç±»ç»„æˆã€‚  
åœ¨ä¸åŒçš„å‘½åç©ºé—´ä¸­ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç°ç±»çš„å®Œæ•´åå­—ï¼ˆåŒ…æ‹¬ç±»çš„åŒ…åï¼‰ç›¸åŒçš„ä¸¤ä¸ªç±»ã€‚

<br>

Qï¼šè¿™é‡Œä¸ºä»€ä¹ˆ setMyPerson æ–¹æ³•ï¼ˆMyPerson#setMyPerson(Object object)ï¼‰çš„å‚æ•°ç±»å‹æ˜¯ Object äº†ï¼Ÿå¯ä»¥å†™æˆ MyPerson å—ï¼Ÿ  
Aï¼šä¸èƒ½å†™æˆ MyPerson ç±»å‹ã€‚å› ä¸ºå†™æˆ MyPerson ç±»å‹çš„è¯ï¼ŒğŸ‘†ç¤ºä¾‹ï¼ˆMyTest21ï¼‰ä¸­çš„  

~~~
# MyPerson

public void setMyPerson(Object object) {
    this.myPerson = (MyPerson)object;
}

æ”¹æˆ ï¼š

public void setMyPerson(MyPerson object) {
    this.myPerson = object;
}


# MyTest21
Method method = clazz1.getMethod("setMyPerson", Object.class);

æ”¹æˆï¼š

Method method = clazz1.getMethod("setMyPerson", MyPerson.class);


# æ§åˆ¶å°
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson
class loader name : loader1
findClass invoked: com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson
class loader name : loader2
false
Exception in thread "main" java.lang.NoClassDefFoundError: com/bayern/shengsiyuan/jvm_lecture/classload/lesson7/MyPerson
    at com.bayern.shengsiyuan.jvm_lecture.classload.lesson8.MyTest21.main(MyTest21.java:36)
Caused by: java.lang.ClassNotFoundException: com.bayern.shengsiyuan.jvm_lecture.classload.lesson7.MyPerson
    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)
    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)
    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
    ... 1 more
~~~

è€Œï¼Œæˆ‘ä»¬å·²ç»å°† MyPerson.class ä»classPathä¸­åˆ é™¤äº†ï¼Œå› æ­¤ï¼Œç¨‹åºèµ°åˆ°â€œMethod method = clazz1.getMethod("setMyPerson", MyPerson.class);â€å°±æŠ›å¼‚å¸¸äº†ï¼Œè€Œä¸æ˜¯åœ¨â€œinvokeâ€çš„æ—¶å€™ã€‚å› ä¸ºï¼ŒMyPerson.class å¯¹ MyTest21.class ä¸å¯è§ã€‚MyPerson.class ç”±â€œè‡ªå®šä¹‰ç±»åŠ è½½å™¨â€åŠ è½½çš„ï¼›è€Œ MyTest21.class ç”±â€œåº”ç”¨ç±»åŠ è½½å™¨â€åŠ è½½çš„ã€‚

<br>

### 4.6 ç ´ååŒäº²å§”æ´¾æ¨¡å‹

* åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸€æ¬¡â€œè¢«ç ´åâ€ï¼šå‘ç”Ÿåœ¨åŒäº²å§”æ´¾æ¨¡å‹å‡ºç°ä¹‹å‰  

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9olje90ptj30nu0gt0uj.jpg)  
ğŸ‘†åŒäº²å§”æ´¾çš„å…·ä½“é€»è¾‘å°±å®ç°åœ¨ã€ClassLoader#loadClass()ã€è¿™ä¸ªæ–¹æ³•ä¹‹ä¸­ï¼ŒJDK 1.2ä¹‹åå·²ä¸æå€¡ç”¨æˆ·å†å»è¦†ç›–loadClass()æ–¹æ³•ï¼Œè€Œåº”å½“æŠŠè‡ªå·±çš„ç±»åŠ è½½é€»è¾‘å†™åˆ°findClass()æ–¹æ³•ä¸­ï¼Œåœ¨loadClass()æ–¹æ³•çš„é€»è¾‘é‡Œå¦‚æœçˆ¶ç±»åŠ è½½å¤±è´¥ï¼Œåˆ™ä¼šè°ƒç”¨è‡ªå·±çš„findClass()æ–¹æ³•æ¥å®ŒæˆåŠ è½½ï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ–°å†™å‡ºæ¥çš„ç±»åŠ è½½å™¨æ˜¯ç¬¦åˆåŒäº²å§”æ´¾è§„åˆ™çš„ã€‚  

<br>

* åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬äºŒæ¬¡â€œè¢«ç ´åâ€ï¼šæ˜¯ç”±è¿™ä¸ªæ¨¡å‹è‡ªèº«çš„ç¼ºé™·æ‰€å¯¼è‡´çš„

è¶ŠåŸºç¡€çš„ç±»ç”±è¶Šä¸Šå±‚çš„åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¦‚æœåŸºç¡€ç±»åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œé‚£è¯¥æ€ä¹ˆåŠï¼Ÿ  
è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨â€œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨â€

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaè®¾è®¡å›¢é˜Ÿåªå¥½å¼•å…¥äº†ä¸€ä¸ªä¸å¤ªä¼˜é›…çš„è®¾è®¡ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆThread Context ClassLoaderï¼‰ã€‚è¿™ä¸ªç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡java.lang.Threadç±»çš„setContextClassLoaser()æ–¹æ³•è¿›è¡Œè®¾ç½®ï¼Œå¦‚æœåˆ›å»ºçº¿ç¨‹æ—¶è¿˜æœªè®¾ç½®ï¼Œå®ƒå°†ä¼šä»çˆ¶çº¿ç¨‹ä¸­ç»§æ‰¿ä¸€ä¸ªï¼Œå¦‚æœåœ¨åº”ç”¨ç¨‹åºçš„å…¨å±€èŒƒå›´å†…éƒ½æ²¡æœ‰è®¾ç½®è¿‡çš„è¯ï¼Œé‚£è¿™ä¸ªç±»åŠ è½½å™¨é»˜è®¤å°±æ˜¯åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ã€‚

æœ‰äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œä¹Ÿå°±æ˜¯çˆ¶ç±»åŠ è½½å™¨è¯·æ±‚å­ç±»åŠ è½½å™¨å»å®Œæˆç±»åŠ è½½çš„åŠ¨ä½œï¼ˆå³ï¼Œçˆ¶ç±»åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡åŠ è½½å™¨å»åŠ è½½å…¶æ— æ³•åŠ è½½çš„ç±»ï¼‰ï¼Œè¿™ç§è¡Œä¸ºå®é™…ä¸Šå°±æ˜¯æ‰“é€šäº†åŒäº²å§”æ´¾æ¨¡å‹çš„å±‚æ¬¡ç»“æ„æ¥é€†å‘ä½¿ç”¨ç±»åŠ è½½å™¨ï¼Œå®é™…ä¸Šå·²ç»è¿èƒŒäº†åŒäº²å§”æ´¾æ¨¡å‹çš„ä¸€èˆ¬æ€§åŸåˆ™ã€‚  
Javaä¸­æ‰€æœ‰æ¶‰åŠSPIçš„åŠ è½½åŠ¨ä½œåŸºæœ¬ä¸Šéƒ½é‡‡ç”¨è¿™ç§æ–¹å¼ï¼Œä¾‹å¦‚JNDIã€JDBCã€JCEã€JAXBå’ŒJBIç­‰ã€‚

å…³äºâ€œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨â€è¯¦è§[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€](/programming_blog/2019/11/06/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨/)

<br>

* åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸‰æ¬¡â€œè¢«ç ´åâ€ï¼šæ˜¯ç”±äºç”¨æˆ·å¯¹ç¨‹åºåŠ¨æ€æ€§çš„è¿½æ±‚è€Œå¯¼è‡´çš„ã€‚  

æ˜¯ç”±äºç”¨æˆ·å¯¹ç¨‹åºåŠ¨æ€æ€§çš„è¿½æ±‚è€Œå¯¼è‡´åŒäº²å§”æ´¾æ¨¡å‹è¢«ç ´åçš„æƒ…æ™¯æœ‰ï¼šä»£ç çƒ­æ›¿æ¢ï¼ˆHotSwapï¼‰ã€æ¨¡å—çƒ­éƒ¨ç½²ï¼ˆHot Deploymentï¼‰ç­‰

OSGiå®ç°æ¨¡å—åŒ–çƒ­éƒ¨ç½²çš„å…³é”®åˆ™æ˜¯å®ƒè‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æœºåˆ¶çš„å®ç°ã€‚æ¯ä¸€ä¸ªç¨‹åºæ¨¡å—ï¼ˆOSGiä¸­ç§°ä¸ºBundleï¼‰éƒ½æœ‰ä¸€ä¸ªè‡ªå·±çš„ç±»åŠ è½½å™¨ï¼Œå½“éœ€è¦æ›´æ¢ä¸€ä¸ªBundleæ—¶ï¼Œå°±æŠŠBundleè¿åŒç±»åŠ è½½å™¨ä¸€èµ·æ¢æ‰ä»¥å®ç°ä»£ç çš„çƒ­æ›¿æ¢ã€‚

åœ¨OSGiç¯å¢ƒä¸‹ï¼Œç±»åŠ è½½å™¨ä¸å†æ˜¯åŒäº²å§”æ´¾æ¨¡å‹ä¸­çš„æ ‘çŠ¶ç»“æ„ï¼Œè€Œæ˜¯è¿›ä¸€æ­¥å‘å±•ä¸ºæ›´åŠ å¤æ‚çš„ç½‘çŠ¶ç»“æ„








