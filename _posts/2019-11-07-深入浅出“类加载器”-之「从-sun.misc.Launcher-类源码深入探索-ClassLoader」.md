---
layout:     post
title:      æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œä» sun.misc.Launcher ç±»æºç æ·±å…¥æ¢ç´¢ ClassLoaderã€
subtitle:   
date:       2019-11-7
author:     tomaså®¶çš„å°æ‹¨æµªé¼“
header-img: img/post-bg-20191014-article1.jpg
catalog: true
tags:
    - Java
    - JVM
---
# æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œä» sun.misc.Launcher ç±»æºç æ·±å…¥æ¢ç´¢ ClassLoaderã€


> æœ¬æ–‡ä¸»è¦æ˜¯ã€Šæ·±å…¥æ¢ç´¢ JVMã€‹ç³»åˆ—ä¸­ã€ç±»åŠ è½½å™¨ã€ç³»åˆ—æ–‡ç« ï¼Œä»[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸‹ï¼‰ã€](programming_blog/2019/11/05/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ç±»åŠ è½½æœºåˆ¶-ä¸‹/)ä¸€æ–‡ä¸­æˆ‘å·²ç»é€šè¿‡å¤§é‡çš„ç†è®ºå’Œç¤ºä¾‹å¯¹ClassLoaderæœ‰äº†æ·±å…¥çš„äº†è§£ã€‚è¯¥æ–‡ï¼Œæˆ‘ä»¬å°†ä» sun.misc.Launcher æºç å¯¹ ClassLoader è¿›è¡Œè¿›ä¸€æ­¥çš„æ¢ç´¢ï¼Œä¹Ÿæ˜¯é™¤äº†ç¤ºä¾‹å¤–çš„å¦ä¸€ä¸ªæ›´æœ¬è´¨çš„è§’åº¦æ¥éªŒè¯æˆ‘ä»¬ä¹‹å‰è¯´çš„ç†è®ºã€‚ã€‚ç³»åˆ—æ–‡ç« ç›®å½•è§ï¼š[ã€Š æ·±å…¥æ¢ç´¢ JVM ã€‹æ–‡é›†](/programming_blog/2019/11/09/æ·±å…¥æ¢ç´¢-JVM-æ–‡é›†/)

<br>

**ã€ç±»åŠ è½½å™¨ã€ç¯‡æ–‡ç« æ¨èï¼š**   
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸Šï¼‰ã€](/programming_blog/2019/11/04/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ç±»åŠ è½½æœºåˆ¶-ä¸Š/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œç±»åŠ è½½æœºåˆ¶ï¼ˆä¸‹ï¼‰ã€](/programming_blog/2019/11/05/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ç±»åŠ è½½æœºåˆ¶-ä¸‹/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€](/programming_blog/2019/11/06/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œä» sun.misc.Launcher ç±»æºç æ·±å…¥æ¢ç´¢ ClassLoaderã€](/programming_blog/2019/11/07/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-ä»-sun.misc.Launcher-ç±»æºç æ·±å…¥æ¢ç´¢-ClassLoader/)  
[æ·±å…¥æµ…å‡ºâ€œç±»åŠ è½½å™¨â€ ä¹‹ã€Œæ¡ˆä¾‹åˆ†æï¼šTomcat ç±»åŠ è½½å™¨æ¶æ„ã€](/programming_blog/2019/11/08/æ·±å…¥æµ…å‡º-ç±»åŠ è½½å™¨-ä¹‹-æ¡ˆä¾‹åˆ†æ-Tomcat-ç±»åŠ è½½å™¨æ¶æ„/)   



<br>

## ä¸€ï¼Œâ€œæ‰©å±•ç±»åŠ è½½å™¨â€å’Œâ€œåº”ç”¨ç±»åŠ è½½å™¨â€ä»¥åŠâ€œè‡ªå®šä¹‰ç±»åŠ è½½å™¨â€éƒ½æ˜¯ç”±â€œå¯åŠ¨ç±»åŠ è½½å™¨â€åŠ è½½çš„ã€‚

é¦–å…ˆï¼Œæ— è®ºæ˜¯â€œç³»ç»Ÿç±»åŠ è½½å™¨â€è¿˜æ˜¯â€œæ‰©å±•ç±»åŠ è½½å™¨â€éƒ½æ˜¯ä½äº sun.misc.Launcher ä¸­ã€‚ä½†æ˜¯ä»–ä»¬çš„è®¿é—®ä¿®é¥°ç¬¦ï¼ˆdefaultï¼‰å¯¼è‡´æˆ‘ä»¬åœ¨å¤–ç•Œæ— æ³•ç›´æ¥è®¿é—®è¿™ä¸ªåŠ è½½å™¨ã€‚

~~~
# sun.misc.Launcher ç±»ä¸­
static class AppClassLoader extends URLClassLoader {
â€¦â€¦
}


static class ExtClassLoader extends URLClassLoader {
â€¦â€¦
}
~~~

å› ä¸º AppClassLoaderã€ExtClassLoader ä¼šåœ¨ Laucher çš„æ„é€ æ–¹æ³•ä¸­è¢«æ„å»ºï¼›è€Œ Launcher çš„é™æ€å±æ€§ä¼šå»æ„å»ºä¸€ä¸ª Launcher å¯¹è±¡ã€‚è€ŒLauncherè¿™ä¸ªç±»åœ¨åŠ è½½çš„æ—¶å€™ä¼šå»åŠ è½½staticé™æ€å—ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æ˜ç¡®Launcherè¿™ä¸ªç±»æ˜¯ç”±â€™å¯åŠ¨ç±»åŠ è½½å™¨â€™åŠ è½½çš„ã€‚ä¹Ÿå°±å¯ä»¥è¯´æ˜â€™æ‰©å±•ç±»åŠ è½½å™¨â€™ä»¥åŠâ€™ç³»ç»Ÿç±»åŠ è½½å™¨â€™æ˜¯ç”±â€™å¯åŠ¨ç±»åŠ è½½å™¨â€™åŠ è½½çš„äº†ã€‚

~~~
# Launcher
private static Launcher launcher = new Launcher();

public Launcher() {
    Launcher.ExtClassLoader var1;
    try {
        var1 = Launcher.ExtClassLoader.getExtClassLoader();    // æ„å»º æ‰©å±•ç±»åŠ è½½å™¨
    } catch (IOException var10) {
        throw new InternalError("Could not create extension class loader", var10);
    }


    try {
        this.loader = Launcher.AppClassLoader.getAppClassLoader(var1);    // æ„å»º ç³»ç»Ÿç±»åŠ è½½å™¨
    } catch (IOException var9) {
        throw new InternalError("Could not create application class loader", var9);
    }


    Thread.currentThread().setContextClassLoader(this.loader);
    String var2 = System.getProperty("java.security.manager");
    if(var2 != null) {
        SecurityManager var3 = null;
        if(!"".equals(var2) && !"default".equals(var2)) {
            try {
                var3 = (SecurityManager)this.loader.loadClass(var2).newInstance();
            } catch (IllegalAccessException var5) {
                ;
            } catch (InstantiationException var6) {
                ;
            } catch (ClassNotFoundException var7) {
                ;
            } catch (ClassCastException var8) {
                ;
            }
        } else {
            var3 = new SecurityManager();
        }


        if(var3 == null) {
            throw new InternalError("Could not create SecurityManager: " + var2);
        }


        System.setSecurityManager(var3);
    }


}

# åŠ è½½ Launcher çš„ç±»åŠ è½½å™¨
System.out.println(Launcher.class.getClassLoader());

# æ§åˆ¶å°
null

ğŸ‘†ç”±æ­¤å¯è§ Launcher æ˜¯ç”±â€™å¯åŠ¨ç±»åŠ è½½å™¨â€™åŠ è½½çš„
~~~

<br>

## äºŒï¼Œæ·±å…¥äº†è§£ ClassLoader.getSystemClassLoader() çš„åº•å±‚å®ç°

~~~
/**
 * Returns the system class loader for delegation.  This is the default
 * delegation parent for new <tt>ClassLoader</tt> instances, and is
 * typically the class loader used to start the application.
 *
 * <p> This method is first invoked early in the runtime's startup
 * sequence, at which point it creates the system class loader and sets it
 * as the context class loader of the invoking <tt>Thread</tt>.
 *
 * <p> The default system class loader is an implementation-dependent
 * instance of this class.
 *
 * <p> If the system property "<tt>java.system.class.loader</tt>" is defined
 * when this method is first invoked then the value of that property is
 * taken to be the name of a class that will be returned as the system
 * class loader.  The class is loaded using the default system class loader
 * and must define a public constructor that takes a single parameter of
 * type <tt>ClassLoader</tt> which is used as the delegation parent.  An
 * instance is then created using this constructor with the default system
 * class loader as the parameter.  The resulting class loader is defined
 * to be the system class loader.
 *
 * <p> If a security manager is present, and the invoker's class loader is
 * not <tt>null</tt> and the invoker's class loader is not the same as or
 * an ancestor of the system class loader, then this method invokes the
 * security manager's {@link
 * SecurityManager#checkPermission(java.security.Permission)
 * <tt>checkPermission</tt>} method with a {@link
 * RuntimePermission#RuntimePermission(String)
 * <tt>RuntimePermission("getClassLoader")</tt>} permission to verify
 * access to the system class loader.  If not, a
 * <tt>SecurityException</tt> will be thrown.  </p>
 *
 * @return  The system <tt>ClassLoader</tt> for delegation, or
 *          <tt>null</tt> if none
 *
 * @throws  SecurityException
 *          If a security manager exists and its <tt>checkPermission</tt>
 *          method doesn't allow access to the system class loader.
 *
 * @throws  IllegalStateException
 *          If invoked recursively during the construction of the class
 *          loader specified by the "<tt>java.system.class.loader</tt>"
 *          property.
 *
 * @throws  Error
 *          If the system property "<tt>java.system.class.loader</tt>"
 *          is defined but the named class could not be loaded, the
 *          provider class does not define the required constructor, or an
 *          exception is thrown by that constructor when it is invoked. The
 *          underlying cause of the error can be retrieved via the
 *          {@link Throwable#getCause()} method.
 *
 * @revised  1.4
 */
@CallerSensitive
public static ClassLoader getSystemClassLoader() {
    initSystemClassLoader();
    if (scl == null) {
        return null;
    }
    SecurityManager sm = System.getSecurityManager();
    if (sm != null) {
        checkClassLoaderPermission(scl, Reflection.getCallerClass());
    }
    return scl;
}
~~~

è¿”å›ä¸€ä¸ªåŸºäºå§”æ‰˜æ¨¡å¼çš„ç³»ç»Ÿç±»åŠ è½½å™¨ã€‚å®ƒæ˜¯æ–°çš„ç±»åŠ è½½å™¨é»˜è®¤çš„å§”æ‰˜çˆ¶ç±»å®ä¾‹ï¼Œå¹¶ä¸”å®ƒæ˜¯ç”¨äºå¯åŠ¨åº”ç”¨çš„å…¸å‹ç±»åŠ è½½å™¨ã€‚  
é¦–å…ˆåœ¨è¿è¡Œæ—¶çš„å¯åŠ¨åºåˆ—ä¸­è°ƒç”¨æ­¤æ–¹æ³•ï¼Œæ­¤æ—¶å®ƒä¼šåˆ›å»ºç³»ç»Ÿç±»åŠ è½½å™¨å¹¶å°†å…¶è®¾ç½®ä¸ºè°ƒç”¨çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ã€‚  
é»˜è®¤çš„ç³»ç»Ÿç±»åŠ è½½å™¨æ˜¯ä¸è¿™ä¸ªå®ç°ç›¸å…³çš„ä¸€ä¸ªå®ä¾‹ã€‚  
å¦‚æœå½“è¿™ä¸ªæ–¹æ³•ç¬¬ä¸€æ¬¡è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œç³»ç»Ÿå±æ€§â€java.system.class.loaderâ€æ˜¯è¢«å®šä¹‰çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§çš„å€¼å°±ä¼šè¢«ä½œä¸ºç³»ç»Ÿç±»åŠ è½½å™¨çš„åå­—ã€‚è€Œè¿™ä¸ªç±»æ˜¯ä½¿ç”¨é»˜è®¤çš„ç³»ç»Ÿç±»åŠ è½½å™¨æ¥å»åŠ è½½çš„ï¼Œå¹¶ä¸”å¿…é¡»å®šä¹‰ä¸€ä¸ªpublicçš„æ¥æ”¶å•ä¸ªç±»å‹ä¸ºClassLoaderå‚æ•°çš„æ„é€ æ–¹æ³•ï¼ŒåŒæ—¶è¿™ä¸ªä¼ å…¥çš„ClassLoaderä¼šä½œä¸ºå§”æ‰˜çš„åŒäº²ã€‚ä¸€ä¸ªå®ä¾‹æ¥ä¸‹æ¥ä¼šè¢«åˆ›å»ºé€šè¿‡ä½¿ç”¨è¿™ä¸ªæ„é€ æ–¹æ³•ï¼ŒåŒæ—¶ä¼šå°†é»˜è®¤çš„ç³»ç»Ÿç±»åŠ è½½å™¨ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œè€Œæ‰€ç”Ÿæˆçš„ç±»å°±ä¼šè¢«å®šä¹‰æˆâ€™ç³»ç»Ÿç±»åŠ è½½å™¨â€™ã€‚  
ä¹Ÿå°±æ˜¯è¯´ï¼Œé»˜è®¤çš„æƒ…å†µä¸‹â€™ç³»ç»Ÿç±»åŠ è½½å™¨â€™å°±æ˜¯â€™AppClassLoaderâ€™ï¼Œä½†æ˜¯å¯¹äºJDKæ¥è¯´ï¼Œå¦‚æœæä¾›äº†â€java.system.class.loader"è¿™ä¸ªç³»ç»Ÿå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªç³»ç»Ÿå±æ€§æ¥å»æ˜¾ç¤ºçš„ä¿®æ”¹â€œç³»ç»Ÿç±»åŠ è½½å™¨â€ï¼Œä¹Ÿå°±æ˜¯è¯´è®©â€œç³»ç»Ÿç±»åŠ è½½å™¨â€ä¸å†æ˜¯â€œAppClassLoaderâ€ï¼Œè€Œæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„æŸä¸ªClassLoaderã€‚

**ç»§ç»­çœ‹ ClassLoader.initSystemClassLoader() æ–¹æ³•**

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ppa90kfoj30om0nbjuc.jpg)

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ppb0s1nlj30qo1q212n.jpg)

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ppbn1pcwj30o30glq69.jpg)

ã€AccessController.doPrivileged(â€¦)ã€: ä¸»è¦æ˜¯å¯¹æƒé™çš„ä¸€ä¸ªæ ¡éªŒã€‚ä½ æ˜¯å¦èƒ½è¿™ä¹ˆå»åšï¼Œæˆ–è€…ä½ æ˜¯å¦æœ‰æƒé™è¿™ä¹ˆå»åšã€‚

**public static Class<?> forName(String name, boolean initialize, ClassLoader loader)**

![](https://tva1.sinaimg.cn/large/006tNbRwgy1g9ppd9t3tqj30qo19jthx.jpg)  
è¿”å›ä¸€ä¸ªç»™å®šå­—ç¬¦ä¸²åå­—çš„ç±»/æ¥å£ç›¸å…³è”çš„ Class å¯¹è±¡ã€‚åŒæ—¶ï¼Œæ˜¯ä½¿ç”¨ç»™å®šçš„ç±»åŠ è½½å™¨å¯¹ Class å¯¹è±¡è¿›è¡ŒåŠ è½½ã€‚ç»™å®šäº†ä¸€ä¸ªç±»/æ¥å£å®Œæ•´çš„å…¨é™å®šåçš„è¯ï¼Œè¿™ä¸ªæ–¹æ³•å°±ä¼šå°è¯•çš„å»å¯»æ‰¾/å®šä½ã€åŠ è½½ï¼Œå¹¶é“¾æ¥ç±»æˆ–æ¥å£ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªæ‰€æŒ‡å®šçš„ç±»åŠ è½½å™¨æ˜¯ç”¨äºåŠ è½½è¿™ä¸ªæŒ‡å®šçš„ç±»æˆ–æ¥å£çš„ã€‚å¦‚æœâ€˜loaderâ€™å‚æ•°ä¸º nullï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±ä¼šé€šè¿‡â€™å¯åŠ¨ç±»åŠ è½½å™¨â€™æ¥è¿›è¡ŒåŠ è½½ã€‚è¿™ä¸ªç±»åªæœ‰å½“â€˜initializeâ€™å‚æ•°ä¸º true è€Œä¸”å…¶å°šæœªè¢«åˆå§‹åŒ–æ—¶ï¼Œè¿™ä¸ªç±»æ‰ä¼šè¢«åˆå§‹åŒ–ã€‚  
å¦‚æœå‚æ•°â€˜nameâ€™è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªâ€œåŸç”Ÿçš„ç±»å‹â€æˆ–è€… â€œvoidâ€ï¼Œåˆ™ä¼šå°†å°è¯•åœ¨åä¸º{@code name}çš„æœªå‘½ååŒ…ä¸­æŸ¥æ‰¾ç”¨æˆ·å®šä¹‰çš„ç±»ï¼ˆå³ï¼Œè¿™é‡Œçš„è¯´çš„ç”¨æˆ·å®šä¹‰çš„ç±»å°±æ˜¯æŒ‡â€™åŸç”Ÿç±»å‹â€™æˆ–â€™voidç±»å‹â€™ï¼‰ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä¸èƒ½ç”¨äºè·å–ä»»ä½•è¡¨ç¤ºâ€œåŸç”Ÿç±»å‹â€æˆ–â€œvoidâ€å¯¹è±¡çš„ã€‚  
å¦‚æœå‚æ•°â€˜nameâ€™è¡¨ç¤ºçš„æ˜¯ä¸€ä¸ªæ•°ç»„ç±»ï¼Œé‚£ä¹ˆæ•°ç»„çš„â€™component typeâ€™å°±ä¼šè¢«åŠ è½½ï¼Œä½†ä¸ä¼šè¢«åˆå§‹åŒ–ã€‚  

~~~
# example:
* <blockquote>
*  {@code Class.forName("Foo")}
* </blockquote>
*
* is equivalent to:
*
* <blockquote>
*  {@code Class.forName("Foo", true, this.getClass().getClassLoader())}
* </blockquote>
~~~

å‚æ•°:  
aï¼‰name â€”â€”â€”â€” æŒ‡å®šç±»çš„å®Œæ•´é™å®šå  
bï¼‰initialize â€”â€”â€”â€” æ˜¯å¦åˆå§‹åŒ–  
cï¼‰loader â€”â€”â€”â€” ç”¨äºåŠ è½½æŒ‡å®šç±»çš„ç±»åŠ è½½å™¨  

> æ³¨æ„ï¼š  
> è¯¥æ–¹æ³•å¹¶ä¸ä¼šæ£€æµ‹æ‰€è¯·æ±‚çš„ç±»å¯¹äºå…¶è°ƒç”¨è€…æ¥è¯´æ˜¯å¦å¯è®¿é—®ã€‚

~~~
# public static Class<?> forName(String className)

public static Class<?> forName(String className)
            throws ClassNotFoundException {
    Class<?> caller = Reflection.getCallerClass();
    // è¿™é‡Œçš„ classLoader æ˜¯ä½¿ç”¨äº†ï¼šåŠ è½½äº†â€œè°ƒç”¨è¯¥æ–¹æ³•çš„ç±»çš„Classç±»â€çš„ç±»åŠ è½½å™¨ã€‚
    return forName0(className, true, ClassLoader.getClassLoader(caller), caller);
~~~

* ã€public static Class<?> forName(String className)ã€ä¸ã€public static Class<?> forName(String name, boolean initialize, ClassLoader loader)ã€çš„åŒºåˆ«ï¼š  
1ï¼ŒåŠ è½½å™¨ï¼ˆè¿™æ—¶ä¸€ä¸ªé‡è¦çš„åŒºåˆ«ï¼‰ï¼š  
ã€public static Class<?> forName(String className)ã€ï¼šä½¿ç”¨åŠ è½½äº†â€œè°ƒç”¨è¯¥æ–¹æ³•çš„ç±»çš„Classç±»â€çš„ç±»åŠ è½½å™¨ï¼›  
ã€public static Class<?> forName(String name, boolean initialize, ClassLoader loader)ã€ï¼šä½¿ç”¨æŒ‡å®šç±»åŠ è½½å™¨ï¼ˆå³ï¼Œé€šè¿‡å‚æ•°â€˜loaderâ€™ä¼ å…¥çš„åŠ è½½å™¨ï¼‰  
2ï¼Œåˆå§‹åŒ–  
ã€public static Class<?> forName(String className)ã€ï¼šä¼šå¯¹æŒ‡å®šçš„ç±»ï¼ˆclassNameï¼‰è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦‚æœè¯¥ç±»æ²¡æœ‰è¢«åˆå§‹åŒ–è¿‡çš„è¯  
ã€public static Class<?> forName(String name, boolean initialize, ClassLoader loader)ã€ï¼šæ˜¯å¦å¯¹æŒ‡å®šç±»ï¼ˆnameï¼‰è¿›è¡Œåˆå§‹åŒ–ï¼Œç”±å‚æ•°ã€Œinitializeã€å†³å®š  



















